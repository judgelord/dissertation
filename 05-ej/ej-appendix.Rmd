---
title: "The Environmental Justice Movement's Impact in Agency Rulemaking"
subtitle: "Technical Appendix and Replication Code" 
author: "Devin Judge-Lord"
output:
    # pdf_document:
    #   toc: true
    #   keep_tex: true
    html_document:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
editor_options: 
  chunk_output_type: console
---


```{r global.options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      cache = FALSE, 
                      fig.width=8.5, 
                      split = T,
                      fig.align = 'center', 
                      fig.path='../figs/',
                      warning=FALSE, 
                      message=FALSE)


library(tidyverse)
library(broom)
library(magrittr)
library(tidytext)
library(knitr)
library(kableExtra)

library(ggplot2); theme_set(theme_bw());
  options(
    ggplot2.continuous.color = "viridis",
    ggplot2.continuous.fill = "viridis"
  )
  scale_color_discrete <- function(...){
    scale_color_viridis_d(..., direction = -1, begin = 0, end = .6, option = "plasma")}
  scale_fill_discrete <- function(...){
    scale_fill_viridis_d(..., direction = -1, begin = 0, end = .6, option = "plasma")}
  
  scale_color_continuous <- function(...){
    scale_color_viridis_c(..., direction = -1, option = "plasma")}
  scale_fill_continuous <- function(...){
    scale_fill_viridis_c(..., direction = -1, option = "plasma")}
  
  
kablebox <- . %>% 
  head(100) %>% 
  knitr::kable(digits = 3) %>% 
  kable_styling() %>% 
  scroll_box(height = "400px")
```

# Data

Replication data are available in SQL and Rdata at https://github.com/judgelord/rulemaking 

```{r data, fig.height=11, cache=TRUE}
load(here::here("data", "ejPRnew.Rdata"))
ejPR <- ejPRnew #FIXME 

load(here::here("data", "ejFRnew.Rdata"))
ejFR <- ejFRnew

load(here::here("data", "ejcommentsnew.Rdata"))
ejcomments <- ejcommentsnew

load(here::here("data", "ej_race.Rdata"))

load(here::here("data", "rules_metadata.Rdata"))


# alternatively 
#rules <- dbGetQuery(con, "SELECT * FROM rules")

# unique
ejPR %<>% 
  select(-page, #FIXME,
         -open_for_comment,
         -type, -document_type, -withdrawn, -links) %>% 
  distinct()

ejFR %<>% 
  select(-page, #FIXME
         -open_for_comment,
         -type, -document_type, -withdrawn, -links) %>% 
  distinct()

ejcomments %<>% 
  select(-lastpage, -type, -document_type, -withdrawn, -links) %>% 
  distinct() 


# a function to clean
clean_summary <- . %>% 
  mutate(summary = str_remove_all(highlighted_content,
               "./em../mark.|.mark..em.") %>% 
           str_replace_all("\\&hellip;\\&nbsp;"," ") %>% 
           str_replace_all("[^[A-z][0-9] \\.\\,\\?\\!\\;&\\;<>]", " ") %>% 
           str_remove_all("\\(|\\)|\\[|\\]") %>%
  str_squish() )

# ## Testing regex
# str_remove_all(ejPRnew$highlighted_content[1],
#                "./em../mark.|.mark..em.") %>% 
#            str_replace_all("\\&hellip;\\&nbsp;"," ") %>% 
#            str_replace_all("[^[A-z][0-9] \\.\\,\\?\\!\\;&\\;<>]", " ") %>% 
#            str_remove_all("\\(|\\)|\\[|\\]") %>%
#   str_squish() 

# summary vars
ejcomments %<>%
  mutate(docket_id = str_remove(id, "-[0-9]*$") ) %>% 
  clean_summary()

ejPR %<>% clean_summary()

ejFR %<>% clean_summary()

rules %<>% filter(document_type %in% c("Proposed Rule", "Rule"),
                    # drop rules before clinton
                  !is.na(posted_date),
                  posted_date > as.Date("1993-01-20"),
                  # rulemaking dockets only
                  docket_type == "Rulemaking" ) %>%
  # one document per docket (drop additional PRs )
  group_by(document_type, docket_id) %>%
  slice_max(number_of_comments_received)


# make summary vars for main data
rules %<>% 
  # # add ej comments and ej unique comment counts #FIXME merge in counts from old data, find if new API has this
  # left_join(ejcomments %>% 
  #             group_by(docket_id) %>% 
  #             summarise(ej_comments = sum(number_of_comments_received) ) ) %>%
  left_join(ejcomments %>% 
              count(docket_id, name = "ej_comments_unique") ) %>% 
  mutate(#ej_comments = replace_na(ej_comments, 0),
         ej_comments_unique = replace_na(ej_comments_unique, 0) ) %>% 
  # recode 1 as 0 to reduce colinearity with ej_comment, logical
  #FIXME make this a new var 
  mutate(ej_comments_unique = ifelse(ej_comments_unique == 1, 0, ej_comments_unique))

# indicators for ej in various docket-level variables
rules %<>% 
  group_by(docket_id) %>% 
  mutate(comments = sum(number_of_comments_received)) %>% 
  ungroup() %>% 
  mutate(ej_pr = docket_id %in% ejPR$docket_id,
         ej_comment = docket_id %in% ejcomments$docket_id,
         ej_fr = docket_id %in% ejFR$docket_id,
         # indicator for president
         president = ifelse(posted_date < as.Date("2017-01-17"), "Obama", "Trump"),
         president = ifelse(posted_date < as.Date("2009-01-20"), "G. W. Bush", president),
         president = ifelse(posted_date < as.Date("2001-01-20"), "Clinton", president),
         year = str_sub(posted_date, 1,4),
         Year = str_sub(posted_date, 3,4),
         Year = str_c("`", Year),
         agency = agency_id
         ) 

rules %<>% select(docket_id, 
                 docket_title, 
                 # ej_comments = ej_comments_unique, 
                 ej_comments_unique, 
                 ej_pr, 
                 ej_comment, 
                 ej_fr, 
                 president, year, 
                 comments, 
                 agency, 
                 document_type,
                 year,
                 Year) %>%
  distinct()
```

### Documents

ej-data-documenttype
```{r ej-data-documenttype, fig.height=3}
# document type over time
rules %>% 
  ggplot() + 
  aes(x = year, fill = document_type) +
  geom_bar(alpha = .7, position = "dodge") + 
  labs(y  = "Number of Documents",
       x = "",
       fill = "") + 
  scale_fill_viridis_d(option="cividis", begin = .3, end = .7, direction = -1, ) +
  theme(axis.text.x = element_text(angle = 45, vjust = .5))
```

### Draft Rules

ej-data-ejpr
```{r ej-data-ejpr, fig.height=3}
# pr over time
rules %>% 
  filter(document_type == "Proposed Rule") %>% 
  ggplot() + 
  aes(x = year, fill = ej_pr) +
  geom_bar(alpha = .7, position = "dodge") + 
  labs(y  = "All Proposed Rules",
       x = "Year",
       fill = "EJ Addressed\nin Proposed Rule") + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5))

# ej_pr over time
ejPR %>% 
  filter(!is.na(posted_date)) %>% 
  mutate(year = str_sub(posted_date,1,4)) %>%
  ggplot() + 
  aes(x = year) +
  geom_bar(alpha = .7, position = "dodge") + 
  labs(y  = "Proposed Rules\nAddressing Environmental Justice",
       x = "Year") + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5))
```

### Final rules
ej-data-ejfr
```{r ej-data-ejfr, fig.height=3}
# fr type over time
rules %>% 
  filter(document_type == "Rule") %>% 
  ggplot() + 
  aes(x = year, fill = ej_fr) +
  geom_bar(alpha = .7, position = "dodge") + 
  labs(y  = "All Final Rules",
       x = "Year",
       fill = "EJ Addressed\nin Final Rule") + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5))

# ej_fr over time
ejFR %>% 
  filter(!is.na(posted_date)) %>% 
  mutate(year = str_sub(posted_date,1,4)) %>%
  ggplot() + 
  aes(x = year) +
  geom_bar(alpha = .7, position = "dodge") + 
  labs(y  = "Final Rules\nAddressing Environmental Justice",
       x = "Year") + 
  theme(axis.text.x = element_text(angle = 45, vjust = .5))



```

Subsets of data:
```{r subsets}
# SUBSETTING -------------------------------------------
#TODO sensitivity analysis to inclusion criteria
# filter to agencies that published at least one ej rule 
rules %<>% 
  group_by(agency) %>% 
  mutate(agency_ej_rules = sum(ej_fr),
         agency_ej_comments = sum(ej_comments_unique),
         agency_ej_nprms = sum(ej_pr)) %>%
  ungroup() %>% 
  filter(agency_ej_rules > 0)# | agency_ej_nprms > 0) #TODO sensitivity analysis

rules %>% distinct(docket_id, ej_pr, ej_fr) %>% count(ej_pr, ej_fr) %>% kablebox()

# All proposed rules
allPR <- rules %>% 
  # subset to final rules
  filter(document_type == "Proposed Rule")


# All final rules
allFR <- rules %>% 
  # subset to final rules with an NPRM 
  filter(document_type == "Rule") %>%
  # direct to final rules
  mutate(direct = ifelse(docket_id %in% allPR$docket_id, "Draft Rule Published", "Direct to Final Rule"))
```

### Agencies that pubished at least 1 rule addressing EJ

Subsetting to agencies that pubished at least one rule explicitly addressing EJ from 1992 through 2020 yields
 `r allPR %>% distinct(docket_id, comments) %>% summarize(n = sum(comments)) %>% pull(n)` public comments on
 `r allFR %>% distinct(docket_id) %>% nrow()` rulemaking dockets from
`r rules %>% distinct(agency) %>% nrow()` agencies, each publishing at least one rule that explicitly addressed environmental justice.  `r ejcomments %>% nrow()` unique comments (excluding duplicates) use the phrase "environmental justice". 


ej-data-agencies
```{r ej-data-agencies}
allFR %>%
  ggplot() + 
  aes(x = year, fill = ej_fr) +
  facet_wrap("agency", scales = "free") +
  geom_bar(alpha = .7) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())  + 
  labs(fill = "EJ in Final Rule",
       x = "",
       y = "")
```

### Agencies that published at least 100 ej comments

ej-data-agencies100
```{r ej-data-agencies100}
breaks <-  c("`16", "`12",  "`08",  "`04", "`00", "`96", "`20")
# agencies that published at least 100 rules with ej comments
allFR %>% 
  filter(agency_ej_comments > 100 | agency == "FEMA",
         year > 1999) %>%
  ggplot() + 
  aes(x = Year, fill = ej_fr) +
  facet_wrap("agency", scales = "free") +
  geom_bar(alpha = .7) + 
  labs(fill = "EJ in Final Rule",
       y = "Number of Rules") + 
  scale_x_discrete(breaks = breaks ) 
```



## Draft Rules by President
ej-pr-president
```{r ej-pr-president, fig.height=2.5}
allPR %>% 
  count(Year, ej_pr, president) %>%
  ggplot() + 
  aes(x = Year, y = n, fill = ej_pr) + 
  geom_col(alpha = .7, position = "dodge") + 
  facet_grid(. ~ president, scales = "free") + 
  labs(x = "Year",
       y = "Number of Proposed Rules",
       fill = "Environmental\nJustice\nAnalysis") + 
  theme(panel.grid.major.x = element_blank())
```


## Final Rules by President

ej_fr-president

```{r ej_fr-president, fig.height=4.5}
allFR %>% 
  count(Year, ej_fr, direct, president) %>%
  ggplot() + 
  aes(x = Year, y = n, fill = ej_fr) + 
  geom_col(alpha = .7, position = "dodge") + 
  facet_grid(direct ~ president, scales = "free") + 
  labs(x = "Year",
       y = "Number of Final Rules",
       fill = "Environmental\nJustice\nAnalysis") + 
  theme(panel.grid.major.x = element_blank())

allFR %>% 
  filter(direct == "Draft Rule Published") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ in Draft & Final Rule", "EJ Only in Final Rule"),
         ej_pr = ifelse(ej_fr, ej_pr, "No EJ Analysis")) %>% 
  count(Year, ej_pr, ej_comment, president) %>% 
  ggplot() + 
  aes(x = Year, y = n, fill = ej_comment) + 
  geom_col(alpha = .7) + 
  facet_grid(ej_pr ~ president, scales = "free") + 
  labs(x = "",
       y = "Number of Rules",
       fill = "Environmental\nJustice\nConcerns") + 
  theme(panel.grid.major.x = element_blank())
```

---

## Comments by President

ej_comments

```{r ej-comments,fig.width=6}
allFR %>% 
  filter(direct == "Draft Rule Published") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ in Draft & Final Rule", "EJ Only in Final Rule"),
         ej_pr = ifelse(ej_fr, ej_pr, "No EJ Analysis")) %>% 
  ggplot() + 
  aes(x = Year, y = comments, color = ej_comment, shape = ej_comment) + 
  geom_point(alpha = .3) + 
  facet_grid(ej_pr ~ president, scales = "free_x") + 
  scale_y_log10(labels = scales::comma)  +
  #scale_x_date(date_labels = "%y") + 
  labs(x = "",
       y = "Number of Comments (log scale)",
       color = "Environmental\nJustice\nConcerns",
       shape = "Environmental\nJustice\nConcerns") +
  scale_x_discrete(breaks = breaks) + 
  scale_color_viridis_d(direction = -1, begin = 0, end = .6, option = "plasma") +
  theme(panel.grid.major.x = element_blank())
```

---

# Proposed rules that **did not** address EJ

```{r}
# Final Rules that where ej was not mentioned in the NPRM
ejFR_PR <- allFR %>% 
  filter(docket_id %in% allPR$docket_id, # there is an NPRM
         !ej_pr) # ej is not in it
```

Percent where the final rule did address EJ


```{r ej-PR-winrate, fig.width=6, fig.height=2}
#ej-PR-winrate 

winrate <- ejFR_PR %>% 
  count(ej_comment, ej_fr) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(ej_fr, n) %>% 
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate %>% kablebox()

ejFR_PR %>% 
  count(ej_comment, ej_fr) %>% 
  left_join(winrate) %>%
  group_by(ej_comment) %>% 
  mutate(mean = mean(c(`TRUE`, `FALSE`)),
        EJ_comment = ifelse(ej_comment, "EJ Raised by Commenters", "EJ not Raised by Commenters")) %>% 
  ggplot() + 
  aes(x = EJ_comment, 
      y = n, 
      fill = ej_fr, 
      label = ifelse(ej_fr == ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7) + 
  geom_text(aes(y = mean)) + 
  facet_wrap("EJ_comment", scales = "free") + 
  labs(fill = "EJ in Final Rule",
       y = "Proposed Rules") + 
  theme_void() +
  theme(axis.text.y = element_text(),
        axis.title.y = element_text(angle = 90),
        panel.grid.major.y = element_line(color = "grey"))
```


## By president


```{r ej-PR-winrate-president, fig.height=2.5, fig.width=6}
#ej-PR-winrate-president

winrate <- ejFR_PR %>% 
  count(ej_comment, ej_fr, president) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(ej_fr, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(`TRUE` = replace_na(`TRUE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate %>% kablebox()

ejFR_PR %>% 
  count(ej_comment, ej_fr, president) %>% 
  left_join(winrate) %>%
  group_by(ej_fr) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "EJ Comments", "No EJ Comments") ) %>% 
  ggplot() + 
  aes(x = n, y = EJ_comment, 
      fill = ej_fr, 
      label = ifelse(ej_fr== ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7) + 
  geom_text(aes(x = `TRUE`), hjust = 0) + 
  facet_wrap("president", scales = "free")+ 
  labs(fill = "EJ in Final Rule",
       x = "Proposed Rules Not Addressing EJ",
       y = "") + 
  #theme_void() +
  theme(axis.text.x = element_text(angle = 30),
        panel.grid.major.x = element_blank())
```


## Model 

```{r ej-m-PR}
# ej-m-PR

m_PR <- glm(ej_fr ~ ej_comment*log(comments+1) +
              ej_comments_unique +
              president,
           data = ejFR_PR, 
             family=binomial(link="logit"))

equatiomatic::extract_eq(m_PR)

tidy(m_PR) %>% kablebox()
```

### Predicted Probabilities by President


With the median number of comments on Proposed Rules that did not address EJ, `r median(ejFR_PR$comments)` comments:

```{r ej-m-PR-president-median, fig.width=5, fig.height=3.5}
# ej-m-PR-president-median

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  expand(ej_comment,
         #ej_comments = median(ej_comments) %>% round(),
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         comments = #c(min(comments),
                      median(comments) %>% round(),
                      #max(comments)),
         president)

predicted <- augment(m_PR,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     ) %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = str_c(ej_comment, ", N = ", n_ej_comment))


# As a plot
predicted %>% 
  ggplot() + 
  aes(x = EJ_comment, y = .fitted, shape = EJ_comment, color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("president", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "",
       color =  '"Environmental Justice"\nRaised by Comments',
       shape =  '"Environmental Justice"\nRaised by Comments',
       title = "Predicted change in Final Rules") + 
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank())+
  ylim(0,1) 
```

---

With the **mean** number of comments on Proposed Rules that did not address EJ, `r mean(ejFR_PR$comments) %>% round()` comments:

```{r ej-m-PR-president-mean, fig.width=5, fig.height=3.5}
# ej-m-PR-president-mean

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  expand(ej_comment,
         #ej_comments = median(ej_comments) %>% round(),
         ej_comments_unique = mean(ej_comments_unique) %>% round(),
         comments = #c(min(comments),
                      mean(comments) %>% round(),
                      #max(comments)),
         president)

predicted <- augment(m_PR,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     ) %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = str_c(ej_comment, ", N = ", n_ej_comment))


# As a plot
predicted %>% 
  ggplot() + 
  aes(x = EJ_comment, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("president", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "",
       color =  '"Environmental Justice"\nRaised by Comments', 
       shape =  '"Environmental Justice"\nRaised by Comments',
       title = "Predicted change in Final Rules") + 
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank())+
  ylim(0,1)
```

---

## By number of comments

```{r ej-m-PR-comments, fig.width=5.25, fig.height=2.5}
# ej-m-PR-comments

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  expand(comments =  c(1, 10,100,1000,10000),
         ej_comment,
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         president = "Obama")

predicted <- augment(m_PR,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     )  %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = str_c(ej_comment, ", N = ", n_ej_comment))


# As a plot
predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Number of Comments",
       color = '"Environmental Justice"\nRaised by Comments',
       shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  
```

---

## By Agency 

The percent of rules where EJ was added

```{r ej-PR-winrate-agency, fig.height=3, fig.width=7}
#ej-PR-winrate-agency

winrate <- ejFR_PR %>% 
  count(ej_comment, ej_fr, agency) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(ej_fr, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(`TRUE` = replace_na(`TRUE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 )) %>% 
  ungroup() %>% 
  arrange(agency)

winrate %>% filter(ej_comment == F) %>% kablebox()

winrate %>% filter(ej_comment == T) %>% kablebox()

# winrate 
ejFR_PR %>% count(agency, ej_comment, ej_fr)  %>% 
  add_count(agency) %>% 
  filter(nn > 3) %>% 
  #filter(agency == "EPA") %>%
  left_join(winrate) %>%
  group_by(ej_fr) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "EJ Comments", "No EJ Comments") ) %>% 
  ggplot() + 
  aes(x = n, y = EJ_comment, 
      fill = ej_fr, 
      label = ifelse(ej_fr== ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7) + 
  geom_text(aes(x = `TRUE`), hjust = 0) + 
  facet_wrap("agency", scales = "free")+ 
  labs(fill = "EJ in Final Rule",
       x = "Draft Rules that Did Not Address EJ",
       y = "") + 
  #theme_void() +
  theme(axis.ticks = element_blank(),
        panel.grid.major.x = element_blank())
```

### Models

```{r}
m_PR_agency <- glm(ej_fr ~ ej_comment*log(comments+1) + 
                     ej_comments_unique + #TODO remove or transform 
                     president + 
                     agency,
           data = ejFR_PR, 
             family=binomial(link="logit"))

tidy(m_PR_agency) %>% kablebox()


#  with ej_comments_unique 
m_nPR_agency <- glm(ej_fr ~ log(comments+1) + 
                     ej_comments_unique + 
                     president + 
                     agency,
           data = ejFR_PR, 
             family=binomial(link="logit"))

tidy(m_nPR_agency) %>% kablebox()
```

### Predicted Probabilies by Agency
```{r ej-m-PR-agency, fig.height=9}
# ej-m-PR-agency

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>%
  expand(ej_comment,
         president = "Obama",
         ej_comments_unique = median(comments) %>% round(),
         comments = median(comments) %>% round(),
         agency)

predicted <- augment(m_PR_agency,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     )  %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = str_c(ej_comment, ", N = ", n_ej_comment))

# calculate difference in probabilities
predicted %<>% 
  group_by(agency) %>% 
  mutate(diff = abs(sum(.fitted) - .fitted - .fitted)*100) %>% 
  mutate(diff = round(diff, 0) %>% str_pad(2, side = "left", pad = "0")) %>% 
  mutate(Agency = str_c(diff, "% increase at ", agency)) %>% arrange(Agency)


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .7)  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  #facet_wrap("agency", ncol = 1, scales = "free") +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "",
       color =  '"Environmental Justice"\nRaised by Comments', shape =  '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules") + 
  theme(#axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

Agencies that have at least 300 comments on proposed rules that did not mention environmental justice (i.e. agencies where at least some of the rules in this dataset saw comments) and at least 3 rules where comments raised EJ concerns (i.e. agencies where EJ is somewhat salient). 

```{r ej-m-PR-agency-top, fig.width=7}
# ej-m-PR-agency-top

ejFR_PR %>% group_by(agency) %>% count(agency, agency_ej_comments,sum(comments) )  %>%   kablebox()


top <- ejFR_PR %>% 
  group_by(agency) %>% 
  filter(sum(comments) >=300,
         agency_ej_comments >=3) %>% 
    ungroup() %>% 
    .$agency %>% 
    unique()


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  filter(agency %in% top) %>% 
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .7)  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "",
       color =  '"Environmental Justice"\nRaised by Comments', shape =  '"Environmental Justice"\nRaised by Comments',
       title = "Predicted change in Final Rules") + 
  theme(panel.grid.major.y = element_blank(),
        axis.ticks.y = element_blank())
```


A more slective subset: Agencies that have at least 500 comments on proposed rules that did not mention environmental justice (i.e. agencies where at least some of the rules in this dataset saw more than a few comments) and at least 50 rules where comments raised EJ concerns (i.e. agencies where EJ is somewhat salient). 

```{r ej-m-PR-agency-toptop, fig.height=3, , fig.width=6}
# ej-m-PR-agency-toptop

# slightly more selective, requiring 100 comments
top <- ejFR_PR %>% 
  group_by(agency) %>% 
  filter(sum(comments) >=500,
         agency_ej_comments >=50) %>% 
    ungroup() %>% 
    .$agency %>% 
    unique()


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  filter(agency %in% top) %>% 
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .5)  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "",
       color =  '"Environmental Justice"\nRaised by Comments', shape =  '"Environmental Justice"\nRaised by Comments',
       title = "Predicted change in Final Rules") + 
  theme(panel.grid.major.y = element_blank(),
        axis.ticks.y = element_blank())
```

## Comments with Agency Fixed Effects 


```{r ej-m-PR-comments-agencyFE, fig.width=5.25, fig.height=2.5}
# ej-m-PR-comments-agencyFE

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  expand(comments =  c(1, 10,100,1000,10000),
         ej_comment,
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         president = "Obama",
         agency = "EPA")

predicted <- augment(m_PR_agency,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     )  %>% 
  left_join(ejFR_PR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = str_c(ej_comment, ", N = ", n_ej_comment))


# As a plot
predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability that "Environmental Justice"\nis Added to Final Rule', 
       x = "Number of Comments",
       color = '"Environmental Justice"\nRaised by Comments',
       shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  
```

---



## Example dockets

Rules where the proposed rule did not address EJ but comments did an the Final Rule did.


EPA-R09-OAR-2010-0120	Revisions to California State Implementation Plans: Imperial County Air Pollution Control District:
>"EPA agrees it is important to consider environmental justice in our actions and we briefly addressed environmental justice principles in our proposal TSD. (171) ..." 

BUT "Environmental Justice" does not appear in the PR, and THERE IS NO OTHER TECHNICAL SUPPORTING DOCUMENT ON REGULATIONS.GOV. FOOTNOTE 171 REFRENCES THE PROPOSED RULE.

> This action will not have disproportionately high and adverse human health or environmental effects on minority, low-income or Tribal populations because it increases the level of environmental protection for all affected populations without having any disproportionately high and adverse human health or environmental effects on any population, including any minority or low-income population. Specially, EPA's limited approval and limited disapproval of Regulation VIII would have the affect of strengthening environmental requirements throughout ICAPCD, and would not relax environmental requirements in any area. Thus it promotes environmental justice by increasing the level of human health and environmental protection for an area where, **as the commenters note, relatively large portions of the population are low income and/or minority**."

---

EPA-R05-OAR-2007-0587	Final Approval of the Wisconsin NOx RACT Rules (NR 428)	
> "The commenter also states that multi facility averaging threatens environmental justice."

---

EPA-R05-OAR-2010-0034	Final Approval of PM 2.5 Clean Data Determination for Saint Louis: 
> "significant source of PM2.5 emissions in the Saint Louis area, and that the plant's operations raise environmental justice concerns. EPA reviewed air quality data throughout the Saint Louis area, including environmental justice areas."

--


EPA-HQ-OAR-2003-0048	National Emission Standards for Hazardous Air Pollutants: Plywood and Composite Wood Products	
> The rule also does not involve special consideration of environmental justice related issues as required by E.O. 12898."

---

EPA-HQ-OAR-2004-0094	National Emission Standards for Hazardous Air Pollutants: General Provisions	Impacts
> Comment: One commenter stated that EPA failed to comply with Executive Order 12898 on Environmental Justice. The commenter asserts that the amendments will adversely affect minority and low income communities around the sources.

> Response: Executive Order 12898 establishes a Federal policy for incorporating environmental justice into Federal agency actions by directing agencies to identify and address, as appropriate, disproportionately high and adverse human health or environmental effects of their programs, policies and activities on minority and low-income populations. The EPA has considered the impact of the proposal on minority and low income populations. **We do not believe that these amendments will have any adverse effects** on emissions during periods of SSM. Therefore, there should not be any adverse impact **on minority and low income populations** as a result of these amendments. The amendments do not affect the underlying requirement to minimize emissions during SSM events. **Owners or operators are still required to develop SSM plans to address emissions** during these periods. They are required to report immediately when the plans are not followed and semiannually when the plans are followed and emission limitations are exceeded (or could have been in the case of malfunctions) and describe steps taken to minimize emissions. **The only difference from current regulations is that the source is not required to follow the plan**, especially when the situation may call for other action or when safety considerations override following the plan as written.

---

Enhancements to Emergency Preparedness Regulations	NRC-2008-0122

> The NRC requested public comments on any environmental justice considerations that may be related to this rule and no comments were received.

BUT, a [comment by Richard Webster & Manna Jo Greene on Behalf of Hudson River Sloop Clearwater, Inc.](https://beta.regulations.gov/comment/NRC-2008-0122-0088) did address EJ:

> The rules and guidance are based on a fantasy world in which the terrain around nuclear power stations is perfectly flat, radiation plumes do not move up and down, the wind  blows at the same speed in a constant direction throughout an accident, and most people follow the instructions they are given about the need to evacuate.

> Need for Site-Specific Analysis of Transport Dependent Populations:
**The present guidance suggests that because 50% of residents would offer rides to those in need, approximately 50% of the transit dependent population in the EPZ would rideshare.** Criteria for Development of ETE Studies (April23, 2009) at 13. **This assumption fails to account for the likely separation of transit dependent environmental justice populations from more affluent populations. Furthermore, it takes no account of attitudes towards race and potential reluctance of whites to offer rides to African- Americans.** Instead of presuming that 50% of the transit dependent population will ride- share, the presumption should be that only a small percentage will rideshare unless the licensee can show that there are no geographical concentrations of transit dependent populations and that there is no racial or sociological bias with regard to ridesharing.

> ...people would be foolish to follow the directions of first responders if they are based on totally unrealistic modeling. Indeed, it is doubtful whether people would follow instructions even if they were based on the best predictions possible. **The experiences during the hurricane Katrina also underline that it is even more doubtful whether the response planned for environmental justice communities would actually materialize.**

---

Atlantic Highly Migratory Species: Atlantic Shark Management Measures; Final Amendment 5b	NOAA-NMFS-2013-0070	

> We received a total of 76 individual written comments on the proposed rule from fishermen, states, and other interested parties during the public comment period, including one comment from EarthJustice that included signatures from 19,716 individuals and another comment from Oceana that included signatures from 13,144 individuals.

>The EPA submitted a comment recommending additional environmental justice information...and include in the EIS whether the proposed alternatives have any potential for disproportionate adverse impacts to minority and low-income populations. The EPA also recommended that the EIS include the approaches used to foster public participation by these populations and describe outreach conducted to all other communities that could be affected by the project, because rural communities may be among the most vulnerable to health risks associated with the project.

> NMFS appreciates these recommendations from the EPA and has added additional information in the environmental justice discussion in Section 9.4 of the FEIS.

Between the time of the proposed rule in 2013 and the final Rule and Final Environmental Impact Statement (FEIS) in 2017, 

> Executive Order 12898 requires agencies to identify and address disproportionately high and adverse environmental effects of its regulations on minority and low-income populations. To determine whether environmental justice concerns exist, the demographics of the affected area should be examined to ascertain whether minority populations and low-income populations are present. If so, a determination must be made as to whether implementation of the alternatives may cause disproportionately high and adverse human health or environmental effects on these populations.
Community profile information are available in the 2006 Consolidated HMS FMP (Chapter 9), a recent report by MRAG Americas, and Jepson (2008) titled “Updated Profiles for HMS Dependent Fishing Communities” (Appendix E of Amendment 2 to the 2006 Consolidated HMS FMP), and in the **2015** HMS SAFE Report. The MRAG report updated community profiles presented in the 2006 Consolidated HMS FMP, and provided new social impacts assessments for HMS fishing communities along the Atlantic and Gulf of Mexico coasts. The 2011 and 2012 SAFE Reports (NMFS 2011 and NMFS 2012) include updated census data for all coastal Atlantic states, and some selected communities that are known centers of HMS fishing, processing or dealer activity. Demographic data indicate that coastal counties with fishing
9-9
communities are variable in terms of social indicators like income, employment, and race and ethnic composition.
The preferred alternatives were selected to minimize ecological and economic impacts and provide for the sustained participation of fishing communities. The preferred alternatives would not have any effects on human health nor are they expected to have any disproportionate social or economic effects on minority and low-income communities.

They also cited research published in the same year as the draft rule:
>Jepson and Colburn (2013) developed social indicators of vulnerability and resilience for 25 communities in the U.S. southeast and northeast regions selected for having a greater than average number of HMS permits associated with them.

---

Fisheries of the Exclusive Economic Zone Off Alaska: Chinook Salmon Bycatch Management in Bering Sea Pollock Fishery	NOAA-NMFS-2010-0032

>Comment 79: NOAA has the responsibility to modify the Council's recommendations to fulfill Federal obligations under ANILCA, ESA, Pacific Salmon Treaty, Environmental Justice, and Federal responsibility to tribal governments. NOAA should fulfill these obligations by not implementing Amendment 91 and insisting on the smaller bycatch rates proposed and supported by the most directly impacted communities.

>Response: NMFS has complied with all applicable laws, Executive Orders, and international obligations in approving and implementing Amendment 91, as documented in the EIS and ROD (see ADDRESSES).

> Comment 96: Subsistence users of the Yukon River, the vast majority of whom are Alaska Native and have the lowest per capita income in the United States, are clearly bearing a disproportionately high adverse environmental impact under Amendment 91. Under the concept of Environmental Justice, why does Amendment 91 result in tribal subsistence users bearing virtually all of the consequences resulting from past, present, and future wasteful bycatch by the pollock fleet? This violates all measures of fairness and fails to satisfy any consideration of environmental justice. The pollock fleet can best afford to make sacrifices in order to accomplish meaningful reductions in Chinook salmon bycatch.

> Response: NMFS acknowledges the comment. The EIS prepared for this action analyzes the environmental justice impacts of this action (see ADDRESSES).

---

EPA-R05-OAR-2020-0055
Removal of Ohio Nuisance Provision (3745-15-07) final rule	

>OAC 3745-15-07 [Ohio State Law] prohibits the “emission or escape into the open air from any source or sources whatsoever, of smoke, ashes, dust, dirt, grime, acids, fumes, gases, vapors, odors, or any other substances or combinations of substances, in such manner or in such amounts as to endanger the health, safety or welfare of the public, or cause unreasonable injury or damage to property.”

> On March 23, 2020, EPA proposed, under the authority of section 110(k)(6) of the CAA, to remove Ohio's nuisance rule from the Ohio State Implementation Plan (SIP) because it does not have a reasonable connection to the attainment and maintenance of the national ambient air quality standard (NAAQS) and EPA erred in approving it as part of the Ohio SIP.

> Comment 10: Commenters state that the NPRM would harm already vulnerable Ohioans by eliminating an important **environmental justice** tool. Commenters also raise concerns with the potential impact on other sensitive populations such as children, the elderly, and individuals with various health issues including respiratory illnesses.

> Response: The purpose of this rulemaking action is to remove OAC 3745-15-07 from the Ohio SIP because it is not related to the implementation, maintenance, and enforcement of the NAAQS. This rulemaking action does not invalidate the Ohio law or affect its applicability to Ohio sources. **Facilities located in Ohio are still subject to the state nuisance rule.** EPA supports programs and activities that promote enforcement of health and environmental statutes in areas with minority populations and low-income populations and the protection of children, the elderly, and other vulnerable populations.



```{r}

top_dockets <- ejFR_PR %>%
  filter(agency %in% c(top, "HUD", "FRA", "DHS", "DOJ", "ED", "DOS", "BIA", "USCBP", "OSHA", "RUS" ),
         ej_fr, # ej added 
         ej_comment) %>% # with ej comments  
  select(docket_id, docket_title) %>% 
  distinct() %>% 
  pull(docket_id)

rules %>% 
  filter(docket_id %in% top_dockets) %>% 
  distinct(docket_id, docket_title, comments, ej_comments_unique) %>%  
  distinct() %>% 
  arrange(rev(docket_id)) %>% 
  kablebox()



# final rule text where the pr did not address ej
ejFR %>% 
  filter(docket_id %in% ejFR_PR$docket_id,
         docket_id %in% ejcomments$docket_id) %>% # EJ not in PR
  distinct(docket_id, title, summary) %>% 
  arrange(desc(docket_id)) %>% 
  kablebox()
```

## Example comments

Excerpts from comments mentioning "environmental justice" on proposed rules that did not address environmental justice: 
```{r}
ejcomments %>% 
  filter(docket_id %in% ejFR_PR$docket_id) %>% 
  distinct(docket_id, title, summary) %>%
  group_by(docket_id) %>%
  slice_sample(n = 2) %>% kablebox()
```

---


# Proposed rules that **did** address EJ

```{r ej-data-ejPR}
# ej-data-ejPR

# Final Rules that where ej was mentioned in the NPRM
ejFRejPR <- allFR %>% 
  filter(#docket_id %in% allPR$docket_id,
         ej_fr,
         ej_pr)

# final rule text where the pr did address ej
change <- ejFR %>% select(docket_id, final = summary) %>% 
  distinct() %>% 
  left_join(ejPR %>% 
              select(docket_id, draft = summary) %>% distinct() ) %>% 
  filter(!is.na(draft))

# indicators 

# is there a comment mentioning ej
change %<>% mutate(ej_comment = docket_id %in% ejcomments$docket_id)

# did the final rule change
change %<>% mutate(change = !str_detect(draft, fixed(final, ignore_case = T) ))
  

change %>% 
  select(docket_id, draft, final, ej_comment, change) %>% kablebox()

change %>% 
  select(docket_id, draft, final, change) %>% kablebox()



# logical
change01 <- change %>% 
  distinct(docket_id, change) %>%
  # dedupe
  group_by(docket_id) %>% 
  slice_max(change) %>% #TODO sensitivity analysis 
  ungroup() 

ejFRejPR %<>% left_join(change01) 

ejFRejPR %>% count(change, ej_comment) %>% kablebox()

ejFRejPR %<>% filter(!is.na(change)) #TODO investigate NAs
```

Percent where the final rule did change how it addressed EJ

```{r ejejPR-winrate, fig.width=6, fig.height=2}
winrate <- ejFRejPR %>% 
  count(ej_comment, change) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(change, n) %>% 
  mutate(percent = round(`TRUE`/(`FALSE`+`TRUE`)*100 ))

winrate %>% kablebox()

ejFRejPR %>% 
  count(ej_comment, change) %>% 
  left_join(winrate) %>%
  group_by(ej_comment) %>% 
  mutate(mean = mean(c(`TRUE`, `FALSE`)),
        EJ_comment = ifelse(ej_comment, "EJ Raised by Commenters", "EJ not Raised by Commenters")) %>% 
  ggplot() + 
  aes(x = EJ_comment, 
      y = n, 
      fill = change, 
      label = ifelse(change == ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7) + 
  geom_text(aes(y = mean)) + 
  facet_wrap("EJ_comment", scales = "free") + 
  labs(fill = "EJ section changed\nin Final Rule",
       y = "Proposed Rules") + 
  theme_void() +
  theme(axis.text.y = element_text(),
        axis.title.y = element_text(angle = 90),
        panel.grid.major.y = element_line(color = "grey"))
```

## Model 

```{r ej-mejPR}
mejPR <- glm(change ~ ej_comment*log(comments +1) +
                #ej_comments + 
                ej_comments_unique +
              president,
           data = ejFRejPR, 
             family=binomial(link="logit"))

tidy(mejPR) %>% kablebox()
```

## By president
```{r ejejPR-winrate-president, fig.height=3}
winrate <- ejFRejPR %>% 
  count(ej_comment, change, president) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(change, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(`TRUE` = replace_na(`TRUE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate %>% kablebox()

ejFRejPR %>% 
  count(ej_comment, change, president) %>% 
  left_join(winrate) %>%
  group_by(change) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "EJ Comments", "No EJ Comments") ) %>% 
  ggplot() + 
  aes(x = n, y = EJ_comment, 
      fill = change, 
      label = ifelse(change== ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7) + 
  geom_text(aes(x = `TRUE`), hjust = 0) + 
  facet_wrap("president", scales = "free")+ 
  labs(fill = "EJ section changed\nin Final Rule",
       y = "",
       x = "Proposed Rules that Did Address EJ") + 
  #theme_void() +
  theme(axis.ticks = element_blank(),
        panel.grid.major.x = element_blank())
```

---

### Predicted Probablities by President

With the median number of comments, `r median(ejFRejPR$comments)`

```{r ej-mejPR-president-median,fig.width=5, fig.height=3.5}
# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  expand(ej_comment,
         #ej_comments = median(ej_comments) %>% round(),
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         comments = #c(min(comments),
                      median(comments) %>% round(),
                      #max(comments)),
         president)

predicted <- augment(mejPR,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     ) %>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = str_c(ej_comment, ", N = ", n_ej_comment))


# As a plot
predicted %>% 
  ggplot() + 
  aes(x = EJ_comment, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("president", ncol = 1) +
  labs(y = 'Probability of Change in How a Rule\nAddresses "Environmental Justice"', 
       x = "",
       color =  '"Environmental Justice"\nRaised by Comments', shape =  '"Environmental Justice"\nRaised by Comments',
       title = "Predicted change in Final Rules") + 
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank())+
  ylim(0,1) 
```

---

With the mean number of comments, `r mean(ejFRejPR$comments) %>% round() %>% as.integer()`

```{r ej-mejPR-president-mean,fig.width=5, fig.height=3.5}
# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  expand(ej_comment,
         #ej_comments = median(ej_comments) %>% round(),
         ej_comments_unique = mean(ej_comments_unique) %>% round(),
         comments = #c(min(comments),
                      mean(comments) %>% round(),
                      #max(comments)),
         president)

predicted <- augment(mejPR,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     ) %>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = str_c(ej_comment, ", N = ", n_ej_comment))


# As a plot
predicted %>% 
  ggplot() + 
  aes(x = EJ_comment, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("president", ncol = 1) +
  labs(y = 'Probability of Change in How a Rule\nAddresses "Environmental Justice"', 
       x = "",
       color =  '"Environmental Justice"\nRaised by Comments', shape =  '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules") + 
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank())+
  ylim(0,1) 
```

---

## By number of comments



Change in EJ section of final rule by number of comments

Percent of rules that change when there are more or less than 10 comments.

```{r ejejPR-winrate-comments, fig.height=1.5, fig.width=5.5}
winrate <- ejFRejPR %>% 
  mutate(comments10 = comments > 9) %>% 
  count(change, comments10) %>% 
  group_by(comments10) %>% #FIXME make nice table with percents
  spread(change, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(`TRUE` = replace_na(`TRUE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate %>% kablebox()

ejFRejPR %>% 
  mutate(comments10 = comments > 9) %>% 
  count(change, comments10) %>% 
  left_join(winrate) %>%
  mutate(comments = ifelse(comments10, "10 or more comments", "Fewer than 10 comments") ) %>% 
  ggplot() + 
  aes(x = n, y = comments, 
      fill = change, 
      label = percent %>% str_c("%")  ) +
  geom_col(alpha = .7) + 
  geom_text(aes(x = `TRUE`), hjust = 0, check_overlap = T) + 
  #facet_wrap("president", scales = "free")+ 
  labs(fill = "EJ section changed\nin Final Rule",
       x = "Proposed Rules that Did Address EJ",
       y = "")
```

### Predicted Probabilities by Number of Comments

Estimates across numbers of comments recieved.

```{r ej-mejPR-comments, fig.height = 2.5, fig.width=5.25}
# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  expand(comments = c(1,10,100,1000,10000) ,
         ej_comment,
         ej_comments_unique = median(ej_comments_unique),
         president = "Obama")

predicted <- augment(mejPR,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     ) %>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = str_c(ej_comment, ", N = ", n_ej_comment))


# As a plot
predicted %>% 
  ggplot() + 
  aes(x = factor(comments), y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability of Change in How a Rule\nAddresses "Environmental Justice"', 
       x = "Number of Comments",
       color =  '"Environmental Justice"\nRaised by Comments',
       shape =  '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  +
  ylim(0,1)
```

---

## By Agency 

```{r ejejPR-winrate-agency, fig.height=4}
winrate <- ejFRejPR %>% 
  count(ej_comment, change, agency) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(change, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(`TRUE` = replace_na(`TRUE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate %>% kablebox()

# winrate 
ejFRejPR %>% count(agency, ej_comment, change)  %>% 
  add_count(agency) %>% 
  filter(nn > 2) %>% 
  #filter(agency == "EPA") %>%
  left_join(winrate) %>%
  group_by(change) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "EJ Comments", "No EJ Comments") ) %>% 
  ggplot() + 
  aes(x = n, y = EJ_comment, 
      fill = change, 
      label = ifelse(change== ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col(alpha = .7) + 
  geom_text(aes(x = `TRUE`), hjust = 0) + 
  facet_wrap("agency", scales = "free")+ 
  labs(fill = "EJ section changed\nin Final Rule",
       x = "Proposed Rules that Did Address EJ", 
       y = "") + 
  #theme_void() +
  theme(axis.ticks = element_blank(),
        panel.grid.major.x = element_blank())
```

### Models 
```{r}
# interaction + agency dummies
mejPR_agency <- glm(change ~ ej_comment*log(comments + 1) + 
                      ej_comments_unique + #TODO this is colinear with above two, estimate nPR models
                      president +
                      agency,
                    data = ejFRejPR, 
                    family=binomial(link="logit"))

tidy(mejPR_agency) %>% kablebox()

# with N ej comments + agency dummies
mejnPR_agency <- glm(change ~ log(comments + 1) + 
                      ej_comments_unique +
                      president,
                    data = ejFRejPR, 
                    family=binomial(link="logit"))

tidy(mejnPR_agency) %>% kablebox()
```

### Predicted Probabilities by Agency

```{r ej-mejPR-agency}
mejPR_agency <- glm(change ~ ej_comment*log(comments + 1) + 
                      ej_comments_unique +
                      president +
                      agency,
                    data = ejFRejPR, 
                    family=binomial(link="logit"))

tidy(mejPR_agency) %>% kablebox()

# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>%
  expand(ej_comment,
         ej_comments_unique = median(comments) %>% round(),
         comments = median(comments) %>% round(),
         president = "Obama",
         agency)

predicted <- augment(mejPR_agency,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     ) 

# calculate difference in probabilities
predicted %<>% 
  group_by(agency) %>% 
  mutate(diff = abs(sum(.fitted) - .fitted - .fitted)*100) %>% 
  mutate(diff = round(diff, 0) %>% str_pad(2, side = "left", pad = "0")) %>% 
  left_join(ejFRejPR %>% count(agency, name = "n_agency")) %>% 
  left_join( ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(Agency = str_c(diff, "% increase at ", agency, ", N = ", n_agency),
         EJ_comment = str_c(ej_comment, ", N = ", n_ej_comment))



# As a plot
predicted %>% 
  arrange(.fitted) %>%
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .7)  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  #facet_wrap("agency", ncol = 1, scales = "free") +
  labs(y = 'Probability of Change in How a Rule Addresses "Environmental Justice"', 
       x = "",
       color =  '"Environmental Justice"\nRaised by Comments', shape =  '"Environmental Justice"\nRaised by Comments',
       title = "Predicted change in Final Rules") + 
  theme(#axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

Agencies that have at least 300 comments on proposed rules that did not mention environmental justice (i.e. agencies where at least some of the rules in this dataset saw comments) and at least 3 rules where comments raised EJ concerns (i.e. agencies where EJ is somewhat salient). 

```{r ej-mejPR-agency-top}
ejFRejPR %>% 
  group_by(agency) %>% 
  count(agency, agency_ej_comments,sum(comments) )  %>%   
  kablebox()


top <- ejFRejPR %>% 
  group_by(agency) %>% 
  filter(sum(comments) >=300,
         agency_ej_comments >=3) %>% 
    ungroup() %>% 
    .$agency %>% 
    unique()


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  filter(agency %in% top) %>% 
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .7)  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  labs(y = 'Probability of Change in How a Rule Addresses "Environmental Justice"', 
       x = "",
       color =  '"Environmental Justice"\nRaised by Comments', shape =  '"Environmental Justice"\nRaised by Comments',
       title = "Predicted change in Final Rules") + 
  theme(panel.grid.major.y = element_blank(),
        axis.ticks.y = element_blank())
```


A more slective subset: Agencies that have at least 500 comments on proposed rules that did not mention environmental justice (i.e. agencies where at least some of the rules in this dataset saw more than a few comments) and at least 50 rules where comments raised EJ concerns (i.e. agencies where EJ is somewhat salient). 

```{r ej-mejPR-agency-toptop, fig.height=3}

# slightly more selective, requiring 100 comments
top <- ejFRejPR %>% 
  group_by(agency) %>% 
  filter(sum(comments) >=500,
         agency_ej_comments >=50) %>% 
    ungroup() %>% 
    .$agency %>% 
    unique()


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  filter(agency %in% top) %>% 
  ggplot() + 
  aes(x = Agency, y = .fitted, shape = EJ_comment,color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .6)  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  labs(y = 'Probability of Change in How a Rule Addresses "Environmental Justice"', 
       x = "",
       color =  '"Environmental Justice"\nRaised by Comments', shape =  '"Environmental Justice"\nRaised by Comments',
       title = "Predicted change in Final Rules") + 
  theme(panel.grid.major.y = element_blank(),
        axis.ticks.y = element_blank())
```


## Comments with Agency Fixed Effects 


```{r ej-mejPR-comments-agencyFE, fig.width=5.25, fig.height=2.5}
# A data frame of values at which to estimate probabilities:
values <- ejFRejPR %>% 
  expand(comments =  c(1, 10,100,1000,10000),
         ej_comment,
         ej_comments_unique = median(ej_comments_unique) %>% round(),
         president = "Obama",
         agency = "EPA")

predicted <- augment(mejPR_agency,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     )  %>% 
  left_join(ejFRejPR %>% count(ej_comment, name = "n_ej_comment") ) %>% 
  mutate(EJ_comment = str_c(ej_comment, ", N = ", n_ej_comment))


# As a plot
predicted %>%
  filter(comments<10001) %>% 
  ggplot() + 
  aes(x = factor(comments), 
      y = .fitted, 
      shape = EJ_comment,
      color = EJ_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit), alpha = .7 )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  #facet_wrap("ej_comment", ncol = 1) +
  labs(y = 'Probability of Change in How a Rule\nAddresses "Environmental Justice"', 
       x = "Number of Comments",
       color = '"Environmental Justice"\nRaised by Comments',
       shape = '"Environmental Justice"\nRaised by Comments',
       title = "Predicted Change in Final Rules")  
```

---


## Example dockets

Rules where the proposed rule did address EJ, the final addressed EJ, and Comments addressed EJ:

```{r}

top_dockets <- ejFRejPR %>%
  filter(agency %in% c(top, "HUD", "FRA", "DHS", "DOJ", "ED", "DOS", "BIA", "USCBP", "OSHA", "RUS" ),
         ej_fr, # ej in final
         ej_comment) %>% # with ej comments  
  select(docket_id, docket_title) %>% distinct() %>% pull(docket_id)

rules %>% filter(docket_id %in% top_dockets) %>% select(docket_id, docket_title, document_type, comments, ej_comments_unique) %>% arrange(docket_id) %>% kablebox()



# final rule text where the pr did not address ej
ejFR %>%
  filter(agency_id %in% c(top, "HUD", "FRA", "DHS", "DOJ", "ED", "DOS", "BIA", "USCBP", "OSHA", "RUS" )) %>%
  filter(docket_id %in% ejFRejPR$docket_id, # ej_added
         docket_id %in% ejcomments$docket_id) %>%  # ejcomments
  distinct(docket_id, title, summary) %>% kablebox()
```

EPA-HQ-RCRA-2012-0121

In 2015, the Environmental Protection Agency (EPA) published a draft rule revising it's hazardous waste generator regulatory program, in part "providing greater flexibility for hazardous waste generators to manage their hazardous waste in a cost-effective and protective manner" (EPA 2015). This draft rule did contain a section addressing Executive Order 12898:

>EPA is allowing VSQGs [very small quantity generators] to ship their hazardous waste to an LQG [large quantity generators]...Although this change could result in an increase in traffic for certain communities, EPA believes the increase would not be significant given that VSQGs currently may send their hazardous waste to a number of destinations, including municipal and non-municipal solid waste management facilities.

>EPA is finalizing alternative standards for VSQGs and SQGs that would allow these entities to maintain their generator category if they generate hazardous waste during an episodic event. Although these generators will be allowed to temporarily manage a greater amount of hazardous waste than their current generator category allows, EPA is finalizing conditions under which the hazardous waste generated from an episodic event must be managed in order to maintain protection of human health and the environment. Therefore, EPA does not anticipate disproportionately high and adverse human health or environmental effects on minority, low-income or indigenous populations from these alternative standards.

EPA-HQ-RCRA-2012-0121 recieved 235 comments, but none raising EJ concerns, and this section was left unchanged in the final rule. (One commentor did attach an annotated copy of the final rule.)

---

## Example comments

Excerpts from comments mentioning "environmental justice" on proposed rules that did not address environmental justice: 

```{r}
ejcomments %>% 
  filter(docket_id %in% ejFRejPR$docket_id) %>% 
  distinct(docket_id, title, summary) %>% kablebox()
```

---


# Regression Tables

```{r results = "asis"}
library(stargazer)
#stargazer::stargazer(m_PR, m_PR_agency, mejPR, mejPR_agency, type = "html")

library(modelsummary)
models <- list(
  "EJ Added 1" = m_PR, 
  "EJ Added 2" = m_PR_agency,
  "EJ Changed 1"  =  mejPR,
  "EJ Changed 2" = mejPR_agency
)

rows <- tibble(
  term = c("President FE", "Agency FE"),
  `EJ Added 1` = c("X", ""), 
  `EJ Added 2` =c("X", "X"), 
  `EJ Changed 1`  = c("X", ""), 
  `EJ Changed 2` = c("X", "X")
)


attr(rows, 'position') <- c(10,11)

# paper table 
modelsummary::modelsummary( models, 
                            stars = TRUE, 
                            coef_omit = "president.*|agency.*|Intercept", 
                          add_rows = rows, 
                          notes = "Full Table in the Online Appendix")


save(models, rows, 
     file = "ej_models.Rdata")

# full table 
modelsummary::modelsummary( models, 
                            stars = TRUE,
                            title = "Including President and Agency Dummies")
```


---

# TODO

- [ ] Transform ej_comments to reduce colinearity with with ej_comment ()

- [ ] Dedupe PRs and FRs, or at least explore sensitivity to which of multiple PRs is used. Perhaps select on `comments` then `posted_date`? The PR with the most comments is most likley the main PR, but many have 0 comments. However, date is complicated. A later PR could be an extension of comment period, a later FR could be a small ammendment. New metadata may help with this. 

- [ ] Compare % in change in 12898 sections vs. rule text vs. response to comment. This requires classifing responses to comment vs adding 12898 section (in most cases, they are adding a 12898 section)

- [ ] Fix +1 shift in predicted prob of logged vars 

- [ ] Investigate other estimators like `clogit`

- 






```{r old-data, include=FALSE, eval=FALSE}
ejcomments %<>% 
  mutate(summary = str_replace(summary, regex("<endeca_term>environmental</endeca_term> <endeca_term>justice</endeca_term>", ignore_case = T), "Environmental Justice")) %>% 
  filter(str_detect(summary,"Environmental Justice")|str_detect(comment_text, regex("environmental justice", ignore_case = T)))

```
