---
# rmarkdown::render("04-influence/influence-appendix.Rmd")
title: "Policy Influence: Do Public Pressure Campaigns Influence Bureaucratic Policymaking?"
subtitle: "Appendix and Replication Code" 
author: "Devin Judge-Lord"
bibliography: '`r here::here("assets/dissertation.bib")`'
biblio-style: '`r here::here("assets/apsr.bst")`'
link-citations: yes
citecolor: black
editor_options: 
  chunk_output_type: console
output:
    bookdown::html_document2:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
---

```{r global.options, include=FALSE}
# load defaults
source(here::here("code", "setup.R"))

# overide defaults
knitr::opts_chunk$set(echo = TRUE, 
                      cache = FALSE)
```



# Data

```{r child = "03-influence-data.Rmd"}
```


---

### Summary counts:

```{r}
# org comments by type 
comments_coded %>% filter(comment_type == "org") %>%  
  mutate(org_type = str_remove(org_type, ";.*")) %>%
  count(org_type, sort =T) %>% 
  filter(n>1) %>% 
  kable3(caption = " ")

# org comments by sub-type
comments_coded %>% filter(comment_type == "org") %>%  
  filter(str_detect(org_type, ";")) %>% 
  mutate(org_type_detailed = org_type) %>%
  count(org_type_detailed, sort =T) %>% 
  kable3(caption = " ")
```


---

Coalitions by type (public interest vs. private interest)

```{r hist-coalitions-type}
ggplot(d %>% drop_na(coalition_type)) + 

    aes(x = as.numeric(coalition_business)) + 
  geom_histogram(stat = "count") + 
  labs(x = "Businesses per coalition",
       title = "Number of Businesses by Coalition Type") + 
  facet_wrap("coalition_type")#, scales = "free_x")

ggplot(coalitions_coded %>% filter(!is.na(coalition_type)), aes(x = Coalition_size)) + 
  geom_histogram(stat = "count")+ 
  labs(x = "Coalition Size",
       title = "Coalition Size by Coalition Type") +
  facet_wrap("coalition_type", scales = "free_x")

ggplot(coalitions_coded %>% filter(!is.na(coalition_type)), aes(x = Comments)) + 
  geom_histogram(stat = "count")+ 
  labs(x = "Total Number of Comments",
       title = "Number of Comments by Coalition Type") +
  facet_wrap("coalition_type", scales = "free_x")
```

---

```{r coded-coalition-congress, include=FALSE, fig.cap= "Lobbying Success by Number of Supportive Comments"}
#FIXME include when I have more MOCs
coalitions_coded %>% 
  drop_na(coalition_type, Coalition_Position) %>% 
  distinct(coalition_comment, coalition_type, coalition_size, coalition_congress, comments, agency, Coalition_Position) %>% 
  ungroup() %>%
  ggplot() +
  aes(y = coalition_congress, x = log(comments), color = coalition_type) +
  geom_jitter(aes(size = coalition_size), alpha = .5) +
  geom_smooth(se = FALSE, method = "lm")+ 
  facet_grid(Coalition_Position ~ .) 
```


#### Number of supportive comments

```{r coded-coalition-success-comments, fig.cap= "Lobbying Success by Number of Supportive Comments", fig.width=5, fig.height=3}
coalitions_coded %>% 
  drop_na(coalition_type, Coalition_Position) %>% 
  distinct(coalition_comment, coalition_type, coalition_size, coalition_success, comments, agency, Coalition_Position) %>% 
  ungroup() %>%
  ggplot() +
  aes(y = coalition_success, x = log(comments), color = coalition_type) +
  geom_jitter(aes(size = coalition_size), alpha = .5) +
  geom_smooth(se = TRUE, method = "lm")

coalitions_coded %>% 
  drop_na(coalition_type, Coalition_Position) %>% 
  distinct(coalition_comment, coalition_type, coalition_size, coalition_success, comments, agency, Coalition_Position) %>% 
  ungroup() %>%
  ggplot() +
  aes(y = coalition_success, x = log(comments), color = coalition_type) +
  geom_jitter(aes(size = coalition_size), alpha = .5) +
  geom_smooth(se = FALSE, method = "lm")+ 
  facet_grid(Coalition_Position ~ .)

coalitions_coded %>% 
  drop_na(coalition_type, Coalition_Position) %>% 
  distinct(coalition_comment, coalition_type, coalition_size, coalition_success, comments, agency, president, Coalition_Position) %>% 
  mutate(comments = comments) %>% 
  ungroup() %>%
  ggplot() +
  aes(y = coalition_success, x = log(comments), color = coalition_type) +
  geom_jitter(aes(size = coalition_size), alpha = .5) +
  geom_smooth(se = FALSE, method = "lm") + 
  #facet_wrap("president")  + 
  facet_grid(Coalition_Position ~ president)
```

#### Coalition Size

(number of supportive organizations)

```{r coded-coalition-success-size, fig.cap= "Lobbying Success by Number of Supportive Comments", fig.width=5, fig.height=3}
coalitions_coded %>% 
  drop_na(coalition_type, Coalition_Position) %>% 
  distinct(coalition_comment, coalition_type, coalition_size, coalition_success, comments, agency, president, Coalition_Position) %>% 
  ungroup() %>%
  ggplot() +
  aes(y = coalition_success, x = coalition_size, color = coalition_type) +
  geom_jitter(aes(size = comments ), alpha = .5) +
  geom_smooth(se = FALSE, method = "lm") + 
  facet_grid(Coalition_Position ~ .)+ 
  scale_size_continuous(labels = comma)

coalitions_coded %>% 
  drop_na(coalition_type, Coalition_Position) %>% 
  distinct(coalition_comment, coalition_type, coalition_size, coalition_success, comments, agency, president, Coalition_Position) %>% 
  ungroup() %>%
  ggplot() +
  aes(y = coalition_success, x = coalition_size, color = coalition_type) +
  geom_jitter(aes(size = comments ), alpha = .5) +
  geom_smooth(se = FALSE, method = "lm") + 
  #facet_wrap("president") + 
  facet_grid(Coalition_Position ~ president)+ 
  scale_size_continuous(labels = comma)
```

#### The correlation between coalition size and the total number of comments

The total number of form-letter comments is highly correlated with the number of organizations in a coalition.

The total number of comments excludes organization comments. 

```{r coalition-size-mass-correlation, out.width="45%", fig.width=2, fig.height=2}
coalitions_coded %>% 
  mutate(comments = comments - coalition_size) %>%
  ggplot() + 
  aes(x = coalition_size, y = comments) +
  geom_point() + 
  geom_smooth(method = "lm")

coalitions_coded %>% 
  mutate(comments = comments - coalition_size) %>%
  ggplot() + 
  aes(x = log(coalition_size), y = log(comments)) +
  geom_point() + 
  geom_smooth(method = "lm")
```

<!--
## Machine-coded Data

> IN PROGRESS

**Dependent variable:** *The percent change in policy text*...

**Explanatory variables:** The *total number of comments*...

-->


---

# Methods


```{r child = "04-influence-methods.Rmd"}
```


---




# Models of lobbying success

## DV = Comments from members of Congress


```{hypothesis oversight, echo = TRUE}
The scale of public engagement moderates elected officials' engagement in agency rulemaking
engagement.
```

> Preliminary finding: The size of the lobbying coalition (the number of organizations) is positively correlated with the number of members of Congress who engage. When we account for variation in coalition size, there is no evidence that the total number of comments is related to the number of comments from members of Congress.

The simplest model of the relationship between congressional attention and public attention is a model estimating the count of legislator letters as a function of features of the rulemaking, including the total number of public comments. The number of letters from members of congress would be a count process; this would be a Poisson or negative binomial regression.

In equation \@ref(eq:oversight1), $y_{j}$ is a count of the number of legislator comments on a proposed rule $j$, $\beta_1$ is the effect of a one-unit increase in the logged number of public comments on proposed rule $j$, and $\eta$ is a vector of coefficients on other factors ($X_{j}$) that may lead legislators to comment.

$$
y_{j}= \beta_0 + \beta_1 \text{log(Public comments)}_{j} + \eta X_{j} + \epsilon_{j} (\#eq:oversight1)
$$

---

Alternatively, if we want to control for legislator characteristics that may make them more or less likely to comment on a rule, we can make members of Congress the unit of analysis. The dependent variable is now whether or not a given legislator $i$ commented on the proposed rule $j$. The relationship between public engagement and legislator engagement can be modeled by Equation \@ref(eq:oversight2), where $Pr(Comment_{ij})$ is the probability that legislator $i$ comments on a proposed rule $j$, $\beta_1$ is the effect of a one-unit increase in the logged number of public comments on proposed rule $j$, and $\eta$ is a vector of coefficients on other factors ($X_{ij}$) that may affect whether a legislator engages.


$$logit(Pr(\text{Legislator comment}_{ij})) = \beta_0 + \beta_1 \text{log(Public comments)}_{ij} + \eta X_{ij} + \epsilon_{ij}
(\#eq:oversight2)$$



---

```{hypothesis beacon, echo = TRUE}
Public pressure campaigns attract
oversight from allies. The more comments supporting a position, the more
likely principals holding that position are to engage.
```

```{hypothesis warning, echo = TRUE}
Public pressure campaigns
reduce oversight from opponents. The more comments opposing a position,
the less likely principals holding that position are to engage.
```

The simplest model of the relationship between congressional attention and public support or opposition to a proposed rule would be to model the net count of legislator letters supporting and opposing the proposed as a function of features of the rulemaking, including the net number of public comments supporting and opposing. As the number of letters from members of congress would be a count process, this would be Poisson or negative binomial regression.

The model is the same as equation \@ref(eq:oversight1) except that $y_{j}$ is now the *net* number of legislator comments supporting a proposed rule $j$, and $\beta_1$ is now the effect of a one-unit increase in the logged *net* number of public comments supporting proposed rule $j$.

---

With a measure of the likely position on each rule (for example, if promulgated by a co-partisan administration), the individual legislator can be the unit of analysis. The probability that legislator $i$ will comment on rule $j$, given their position $p_{ij}$ on a proposed rule $j$ ($Pr(Comment_{ij}i|p_{ij})$), is modeled in equation \@ref(eq:oversight4). Hypothesis \@ref(hyp:beacon) implies that $\beta_1$ is positive and
Hypothesis \@ref(hyp:warning) implies that $\beta_2$ is negative.


$$logit(Pr(\text{Legislator Comment}_{ij}|p_{ij})) = \beta_0 + \beta_1 \text{Comments supporting } p_{ij} + \beta_2 \text{Comments opposing } p_{ij} + \eta X_{ij} + \epsilon_{ij}
(\#eq:oversight4)$$

---


<!-- THIS IS WHERE THE RESULTS SECTION STARTS ---> 

## Results: Lobbying success

This section leverages data on a sample for agency rules for which I have hand-coded nearly all public comments.  Comment-level observations are nested within an organization, within a coalition, within a rule, within an agency, within an administration. Thus, I use hierarchical models. I use data at the organization level and rolled up to the coalition level (coalitions range from 1 to 200 organizations in size) with random effects to account for dependence among observations at heigher levels of analysis.

The dependent variable for most analysis is the organization or coalition's lobbying success, hand-coded on the interval between 2 (policy changed as requested) to -2 (policy changed in the opposite direction requested). 

The main variable of interest is the total number of form-letter public comments that a lobbying coalition generated. 

I assess the relationship between lobbying success and public pressure by modeling coalition $i$'s lobbying success in a rulemaking $j$, $y_{ij}$ as a combination of
<!--the relative length of the (lead) organizations comment,--> 
the coalition's size, and the number of mass comments (logged in some specifications), the type of coalition (e.g. a business or public interest coalition), whether the coalition supported the proposed rule, and whether the coalition lobbied unopposed. I estimate these relationships using OLS regression. Other estimators yield similar results. <!--I also estimate hand-coded lobbying success with beta regression and ordered logit, which is more appropriate but less interpretable. For the automated measures of lobbying success, I estimate beta regression models with the same variables.-->


$Y_{ij} = \boldsymbol{\beta}_1 \textbf{log(Comments)}_{ij} + {\beta}_2\text{Size}_{ij} + {\beta}_3\text{Unopposed}_{ij}  + {\beta}_3\text{Coalition Type}_{ij} + \epsilon_{ij}$

I use two related measures of coalition type. Models 1 and 3 use my classification of coalitions as primarily public or private interests. Models 2 and 4 below use a related measure: the share of coalition members that are businesses or trade associations. Models 3 and 4 include interacting each measure of the coalition's type with a dummy for president Trump rather than President Obama's administration. Bush-era rules are dropped from these models for simplicity. 

### Coalition Success as the Dependent Variable

These models include coalitions of 1 (organizations lobbying alone), but results are similar if I exclude them, except that coalition size has a much weaker correlation with success. 

The main coeficient of interest (the estimated relationship between the number of comments and lobbying success) is negative across model specifictions, suggesting the larger pressure campaigns are less likely to win. 

The other result aparent from these models is that public interest groups were more likely to win under presendent Obama and less likely to win under president Trump. Likewise, business-led coalitions were less likely to win under president Obama than under president Trump. 

> NOTE: At this time, the sample mostly rules that received an unusual number of comments, so these results are based on variation with high-salience rulemakings. 

> TODO: Add specification with agency fixed effects?

With public pressure as a dummy--did the coalition sponsor a public pressure campaign? 
```{r model-success-dummy, cache=FALSE}
coalitions_coded %<>% mutate(campaign = comments > 99)

m_business <- lm(coalition_success ~ 
          campaign + 
          #comment_length + 
          coalition_business +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded) 

m <- lm(coalition_success ~ 
          campaign + 
          #comment_length + 
          coalition_type +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded) 

m_business_president <- lm(coalition_success ~ 
          campaign + 
          #comment_length + 
          coalition_business*president +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded %>% filter(president != "Bush")) 

m_president <- lm(coalition_success ~ 
          campaign + 
          #comment_length + 
          coalition_type*president +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded %>% filter(president != "Bush")) 

models <- list(m, 
               m_business, 
               m_president,
               m_business_president)

modelsummary(models, stars = TRUE)
```

```{r model-success, cache=FALSE}
m_business <- lm(coalition_success ~ 
          log(comments) + 
          #comment_length + 
          coalition_business +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded) 

m <- lm(coalition_success ~ 
          log(comments) + 
          #comment_length + 
          coalition_type +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded) 

m_business_president <- lm(coalition_success ~ 
          log(comments) + 
          #comment_length + 
          coalition_business*president +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded %>% filter(president != "Bush")) 

m_president <- lm(coalition_success ~ 
          log(comments) + 
          #comment_length + 
          coalition_type*president +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded %>% filter(president != "Bush")) 

models <- list(m, 
               m_business, 
               m_president,
               m_business_president)

modelsummary(models, stars = TRUE)
```

My preferred model is model 3: 

```{r model-success-plot, cache=FALSE,  fig.width=6, fig.height=2, out.width = "100%", fig.cap= "OLS Model of Coalition Lobbying Sucess with Hand-coded Data"}
# model-success-plot
m_president %>%
  tidy(conf.int = TRUE) %>% 
  filter(term != "(Intercept)") %>% 
  ggplot() + 
  geom_hline(yintercept = 0, color = "grey") + 
  aes(x = term, 
      y = estimate, 
      ymin = conf.low, 
      ymax = conf.high) + 
  geom_pointrange( )  + 
  coord_flip() +
  labs(y = "Lobbying Success", 
       x = "") 
```

<!--
**Excluding** coalitions of 1 (organizations lobbying alone):

```{r model-success-restricted, cache=FALSE}
m_business <- lm(coalition_success ~ 
          log(comments) + 
          #comment_length + 
          coalition_business +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded %>% filter(coalition_size != 1)) 

m <- lm(coalition_success ~ 
          log(comments) + 
          #comment_length + 
          coalition_type +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded %>% filter(coalition_size != 1)) 

m_business_president <- lm(coalition_success ~ 
          log(comments) + 
          #comment_length + 
          coalition_business*president +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded %>% filter(president != "Bush")%>% filter(coalition_size != 1)) 

m_president <- lm(coalition_success ~ 
          log(comments) + 
          #comment_length + 
          coalition_type*president +  
          log(coalition_size) + 
          coalition_unopposed, 
        data = coalitions_coded %>% filter(president != "Bush")%>% filter(coalition_size != 1)) 

models <- list(m, 
               m_business, 
               m_president,
               m_business_president)

modelsummary(models, stars = TRUE)
```


```{r model-success-plot-restricted, cache=FALSE,  fig.width=6, fig.height=2, out.width = "100%", fig.cap= "OLS Model of Coalition Lobbying Sucess with Hand-coded Data"}
# model-success-plot
m_president %>%
  tidy(conf.int = TRUE) %>% 
  filter(term != "(Intercept)") %>% 
  ggplot() + 
  geom_hline(yintercept = 0, color = "grey") + 
  aes(x = term, 
      y = estimate, 
      ymin = conf.low, 
      ymax = conf.high) + 
  geom_pointrange( )  + 
  coord_flip() +
  labs(y = "Lobbying Success", 
       x = "") 
```
-->

#### Modeling Congressional Support as a Mediator of Lobbying Success

To assess congressional support as a mediator in the influence of public pressure campaigns on rulemaking, I estimate the average conditional marginal effect (ACME, conditional on the number of comments from Members of Congress) and average direct effect (ADE) of mass comments using mediation analysis. Model 3 in table \@ref(tab:mediation) replaces the dependent variable (lobbying success) with the mediator variable (the number of supportive members of Congress). Model 1 is the same as Model 1 above. Model 2 is the same but includes the proposed mediator, the number of supportive comments from members of Congress.


---

##### Mediator model \@ref(eq:mediator):

$$
\text{Congressional support}_{ij} = \beta_0 + \beta_1 log(\text{Comments}_{ij}) + \beta_{2-n} X_{ij} + \epsilon_{ij} (\#eq:mediator)
$$

```{r model-oversight, cache=FALSE}
# poisson correct model 
m_congress <- glm(coalition_congress ~  log(comments) + #comment_length +
                coalition_type +  log(coalition_size) + coalition_unopposed,
               family = "poisson",
               data = coalitions_coded %>% filter(!is.na(coalition_success))) 

summary(m_congress)

# model predicting mediator
model.m <- lm(coalition_congress ~  log(comments) + #comment_length +
                coalition_type +  log(coalition_size) + coalition_unopposed,
               data = coalitions_coded %>%
                filter(!is.na(coalition_success))) 


mediator <- list("Members of Congress in Coalition (OLS)" = model.m, "Members of Congress in Coalition (Poisson)" = m_congress)

modelsummary(mediator, stars = TRUE)
```


```{r model-oversight-plot, eval=FALSE, cache=FALSE,  fig.width=6, fig.height=2, out.width = "100%", fig.cap= "OLS Model of the Numeber of Members of Congress Per Coalition with Hand-coded Data"}
# FIXME include = TRUE when more obs
model.m %>%
  tidy(conf.int = TRUE) %>% 
  filter(term != "(Intercept)") %>% 
  ggplot() + 
  geom_hline(yintercept = 0, color = "grey") + 
  aes(x = term, 
      y = estimate, 
      ymin = conf.low, 
      ymax = conf.high) + 
  geom_pointrange( )  + 
  coord_flip() +
  labs(y = "Number of Legislator Comments", 
       x = "") 
```


---

##### Outcome model 


```{r causal-oversight-2, fig.cap = "Integrating Public Pressure and Congressional Oversight into a Model of Lobbying in Bureaucratic Policymaking"}
#TODO label "Public Pressure" and "Oversight" portions. 
knitr::include_graphics(here::here("figs", "causal-oversight-2.png"))
```



($y_{ij} = \text{Lobbying success}_{ij}$) \@ref(eq:outcome):


$$
y_{ij} = \beta_0 + \beta_1 log(\text{Comments}_{ij}) + \beta_2 \text{Congressional support}_{ij} + \beta_{3-n} X_{ij} + \epsilon_{ij} 
(\#eq:outcome)
$$



```{r mediation, cache=FALSE}
# model predicting DV
model.y <- lm(coalition_success ~ log(comments) + 
                coalition_congress + #comment_length + 
                coalition_type +  
                log(coalition_size) + 
                coalition_unopposed, 
              data = coalitions_coded) 

# Mediation 
med.cont <- mediate(model.m, model.y,
                    sims=1000, 
                    treat = "log(comments)", 
                    mediator = "coalition_congress")

summary(med.cont)


models <- list(
  "1" = m,
  "2" = model.y,
  "3"  =  model.m
)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = c("Lobbying Success"), 
  `2` =c("Lobbying Success"), 
  `3`  = c("Members of Congress in Coalition")
)

# #broom::tidy(m_PR)
# cm = c("ej_commentTRUE" = "EJ Comment",
#        "log(comments + 1)" = "Log(Comments+1)",
#        "ej_comments_unique" = "Unique EJ Comments",
#        "ej_commentTRUE:log(comments + 1)" = "EJ Comment*Log(Comments+1)")

attr(rows, 'position') <- c(0)

# paper table
modelsummary::modelsummary( models,
                            title = "Lobbying Success and Congressional Support",
                            stars = TRUE,
                            #coef_omit = "president.*|agency.*|Intercept",
                            # coef_map = cm,
                          add_rows = rows,
                          notes = "") %>%
  row_spec(row = 1, bold = T) #%>% kable2(file = "mediation")
```

> Mediation analysis will require adding cases where coalitions lobbied unopposed, which we are much more likely to see in the sample of rules without mass comments.



The average effect of the logged number of comments, conditional on letters from members of congress (the ACME) is `r round(med.cont$d.avg, 2)`, with a p value of `r round(med.cont$d0.p, 4)`.

The average direct effect (ADE) of the logged number of comments on lobbying success is `r round(med.cont$z0, 2)`, with a p-value of `r round(med.cont$z0.p, 4)`.

The Total Effect of a one-unit increase in the logged number of comments is `r round(med.cont$tau.coef, 2)`, with a p value of `r round(med.cont$tau.p, 2)`. `r round(med.cont$n0, 2)` of this is mediated through mobilizing congressional attention (p-value = `r round(med.cont$n0.p, 2)`).

### Organization success as the Dependent Variable

While it would not be appropriate to compare the lobbying success of organizations *within* a rulemaking (because many organizations belong to the same coalition), it may be appropriate to compare the lobbying success *within* the same organization *across* rules. This limits the analysis to organizations that lobbying on multiple policies. The key variation of interest is when organizations lobby with a large amount of public support versus when they do not.


There is still a (lesser) problem with the i.i.d. assumption here because two organizations lobbying in a coalition on one rule may mobilize each other to lobby in coalition in a different rule (in my data, lobbying coalitions are at the policy-level, since they differ from policy to policy). 

```{r}
orgs <- comments_coded %>% 
  filter(comment_type == "org") %>% 
  distinct(org_name, docket_id, success, Position, coalition_size, coalition_comments, president) %>% 
  count(org_name, sort = T) %>% 
  filter(n >1, !is.na(org_name)) 

orgs %>% kable3(caption = " ")
```

`r nrow(orgs)` organizations lobbied on more than one rule in the hand-coded data, some on as many as `r max(orgs$n)` rulemaking dockets. This yields a total of `r sum(orgs$n)` observations of an organization lobbying on a docket that also lobbied on some other docket. 
(Note: this is a undercount due to imperfect standardization of organization names).


At the organization level, the appropriate analysis is a difference-in-difference design. We know the success of each organization when it does and does not participate in a lobbying coalition that mobilizes public pressure (at least each organization that I can use for this analysis). The difference within an organization is now the key variation.  

$Y_{ij} = \boldsymbol{\beta}_1 \textbf{Comments}_{ij} + \gamma_{i} + {\beta}_2\text{Coalition Size}_{ij} + {\beta}_3\text{Support}_{ij}  + {\beta}_4\text{President}_{j} + \epsilon_{ij}$

<!--+ {\beta}_5\text{Coalition Type}_{ij} +{\beta}_6\text{Coalition Type}_{ij}*\text{President}_{j} -->

Where $Y_{it}$ represents organization $i$'s level of success. $\gamma_{ij}$ is a fixed effect for
the organization. This fixed effect accounts for the organization's
characteristics that do not vary over time. This difference-in-difference design ensures that
coefficient $\boldsymbol{\beta}_1$ captures variation related to changes
in levels of public pressure, not other factors that may vary
across organizations. <!--The model also accounts for
the different periods for which data were available from each agency.
$\delta_{jt}$ is an agency-year fixed effect, takes into account
agency-level common shocks across commenters in responsiveness to comment.-->



${\beta}_2$ captures the effect of coalition size on lobbying success of organization $i$ on rule $j$. ${\beta}_3$ captures the difference in the success of organization $i$ when they support proposed policy $j$ rather than oppose it. ${President}_{j}$ is a dummy for whether policy $j$ was proposed by President Trump rather then-president Obama's administration.

Assuming that organizations have parallel trends in their level of success given a level of support, $\boldsymbol{\beta}$ represents the average effect of changing levels of public pressure on an organization's lobbying success.

Estimates in the table below show the results of this model. It suggests that the same organization was less effective when it mobilized more comments, more successful when they supported the rule, and less successful under president Trump than President Obama. 

The negative correlation between lobbying success and the number of mass comments is likely due to campaigns "going down fighting"--not trying to influence policy. The fact that organizations are more likely to get the outcome they seek when they already support the rule makes sense because the agency is more likely to be sympathetic to their requests. The fact that the average organization was less likely to see its desired policy changes under President Trump is likely due to asymmetry in mobilizing organizations, with more organizations on the left than the right in this sample of rules. (Note: this may change in the broader sample.)

<!--
Model 2 shows a similar model, adding a fixed effect for the rulemaking docket (i.e., each policy on which an organization comments). Because I consider policies published by different administrations to be distinct, regardless of the docket id number used, the president does not vary across dockets, and it no longer makes sense to include the president dummy. 

This model also shows...
Because relatively few campaigns mobilize on any given rulemaking docket, there is little variation within dockets.
-->
```{r m-coded-org-success-did}
library(fixest)

m_fe_org = feols(success ~ log(coalition_comments) + coalition_size + Position + president | org_name,
               data = comments_coded %>% 
  filter(comment_type == "org") %>% 
  distinct(org_name, docket_id, success, Position, coalition_size, coalition_comments, president) %>% filter(president != "Bush"))

models <- list("Lobbying Success" = m_fe_org)

modelsummary(models, stars = T)
```

### Mixed effects / hierarchical models

Because organizations are nested in coalitions, I estimate a hierarchical model grouping by coalition. 

```{r}
library(lme4)

# mixed model with random effects for coalition
m_me = lmer(success ~ log(coalition_comments)*coalition_type*president +
              Position + 
              log(coalition_size) + 
              (1|coalition),
               data = comments_coded %>% 
  filter(comment_type == "org") %>% 
  distinct(org_name, docket_id, success, coalition_type, coalition_size, Position, coalition_comments, president, coalition, agency) %>% filter(president != "Bush"))


broom.mixed::tidy(m_me) %>% 
  mutate(term = ifelse(str_detect(term, "sd__.Int"), paste(group, term), term)) %>%  
  dwplot + geom_vline(xintercept=0,lty=2)

models <- list("Lobbying Success" = m_me)

modelsummary(models)
```

```{r, eval = FALSE}

tidy(m_me_type, conf.int = T)



tidy(m_me_type,effects="fixed")

fixef(m_me) #is the canonical way to extract coefficients from mixed models 

# you can get the full coefficient table with coef(summary(m)); if you have loaded lmerTest before fitting the model, or convert the model after fitting (and then loading lmerTest) via coef(summary(as(m,"merModLmerTest"))), then the coefficient table will include p-values. (The coefficient table is a matrix; you can extract the columns via e.g. ctab[,"Estimate"], ctab[,"Pr(>|t|)"], or convert the matrix to a data frame and use $-indexing.)

# get likelihood profile confidence intervals via 
confint(m_me) #; these may be computationally intensive. If you use confint(m, method="Wald") you'll get the standard +/- 1.96SE confidence intervals. (lme uses intervals(m) instead of confint().)

broom.mixed::tidy(m_me,effects="fixed")
# gives you a table with estimates, standard errors, etc.
# tidy(as(m,"merModLmerTest"), effects="fixed") (or fitting with lmerTest in the first place) includes p-values
# adding conf.int=TRUE gives (Wald) CIs
# adding conf.method="profile" (along with conf.int=TRUE) gives likelihood profile CIs
# You can also get confidence intervals by parametric bootstrap (method="boot"), which is considerably slower but more accurate in some circumstances.

library(dotwhisker)

broom.mixed::tidy(m_me_position,effects="fixed", conf.int = T)

broom.mixed::tidy(m_me_position) %>% mutate(term = ifelse(str_detect(term, "sd__.Int"), paste(group, term), term)) %>%  dwplot + geom_vline(xintercept=0,lty=2)

coalitions_coded %>% count(coalition, sort = T)

# A data frame of values at which to estimate probabilities:
values <- comments_coded %>% 
  tidyr::expand(`log(coalition_comments)` = seq(0:10),
                `log(coalition_size)` = seq(0:1),
                Position,
                coalition = c("Aclu", "American Petroleum Institute", "Defenders Of Wildlife"),
                president)

broom.mixed::augment(m_me_position, 
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE) %>% 
  #filter(`log(coalition_size)`==0) %>% 
  ggplot() + 
  aes(x = `log(coalition_comments)`, y = .fitted,) +
  geom_point() +
        facet_grid(Position ~ president)
```
