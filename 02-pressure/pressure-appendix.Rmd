---
# rmarkdown::render("02-pressure/pressure-appendix.Rmd")
title: "Public Pressure: Why Do Agencies (sometimes) Get So Much Mail?"
subtitle: "Appendix and Replication Code" 
author: "Devin Judge-Lord"
output:
    # pdf_document:
    #   toc: true
    #   keep_tex: true
    html_document:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r global.options, include=FALSE}
# load defaults
source(here::here("code", "setup.R"))

# overide defaults
knitr::opts_chunk$set(echo = TRUE, 
                      cache = FALSE)
```





<!-- 02-pressure-data.Rmd-->

### Data: A Census of Public Pressure Campaigns {#pressure-data}

```{r influence-data}
load(here::here("data", "rules_metadata.Rdata"))

# Replication data are available in SQL and Rdata at <https://github.com/judgelord/rulemaking>.
#rules <- dbGetQuery(con, "SELECT * FROM rules")

#FIXME move date var to rulemaking repo
rules %<>%
  mutate(comment_start_date = comment_start_date %>% as.Date(),
         comment_due_date = comment_due_date %>% as.Date(),
         date = coalesce(posted_date, comment_start_date, comment_due_date),
         year = str_sub(date, 1,4),
         year2 = str_remove(docket_id, ".*[A-Z]-") %>%
           str_remove("-.*"),
         year = coalesce(year, year2) %>% as.numeric()
                      ) %>%
  select(-year2) 

# d is rules subset to study years
d <- rules %>% 
  filter(year > 2004, year < 2021, document_type %in% c("Proposed Rule", "Rule"))

load(here::here("data", "comments_min.Rdata"))

# add docket_id
comments_min %<>% 
  mutate(docket_id = id %>% str_remove("-[0-9]*$"))

# hand coded 
load(here::here("data", "coalitions_coded.Rdata"))
load(here::here("data", "comments_coded.Rdata"))
# load(here::here("data", "mass_coded.Rdata"))

# common names 
comments_coded %<>% 
  mutate(coalition = coalition_comment,
         agency = str_remove(docket_id, "-.*"))%>%
  mutate(org_name = org_name %>% str_to_title())%>%
  mutate(coalition = coalition %>% str_to_title())

# common names 
coalitions_coded %<>% 
  mutate(coalition_comments = coalition_comments - coalition_size +1 , coalition = coalition_comment,
         comments = coalition_comments,
         Comments = Coalition_comments,
         agency = str_remove(docket_id, "-.*"))%>%
  mutate(coalition = coalition %>% str_to_title())

# inspect
# coalitions_coded$coalition_comments %>% min()

comments_coded %<>% mutate(across(where(is.character), str_to_title))
coalitions_coded %<>% mutate(across(where(is.character), str_to_title))

# TODO merge in mass comments that were not hand-coded 
```

To examine the relationship between public pressure campaigns and lobbying success, I use an original dataset (introduced in \@ref(whymail-data)) that combines several data sources on U.S. federal agency rulemaking.

Up to 2020, these data include `r unique(rules$docket_id) %>% length()`
dockets,
`r rules %>% filter(docket_type == "Rulemaking") %>% distinct(docket_id) %>% nrow()`
rulemaking dockets. These dockets received
approximately `r sum(rules$number_of_comments_received, na.rm = T)`
comments.

The core data for this analysis are the texts of draft and final rules and public comments on these proposed rules published from 2005 to 2020. 
This includes all proposed rules from `r d %>% filter(number_of_comments_received >0) %>% pull(agency_id) %>% unique() %>% length()` agencies that were open for comment on regulations.gov between 2005 and 2020, received at least one comment from an organization, and saw a final agency action between 2005 and 2020.  These 
`r d %>% filter(docket_type == "Rulemaking") %>% distinct(docket_id) %>% nrow()`
rulemaking dockets received a total of
`r d %>% filter(docket_type == "Rulemaking") %>% pull(number_of_comments_received) %>% sum(na.rm = T)`
comments.

<!--TODO: This should be a short review and addition to the data section in whymail-->

I collected draft and final rule texts from federalregister.gov and comments submitted as attachments or by mail from regulations.gov. 
I retrieve comments submitted directly on regulations.gov and metadata on rules and comments (such as the dates that the proposed rule was open for comment and whether the agency identified the organization submitting the comment) from the regulations.gov API. 
I add additional metadata on rules (such as whether the rule was considered "significant") from the Unified Agenda published by the Office of Information and Regulatory Affairs (reginfo.gov). 

Where a new presidential administration used the same docket number to solicit comments on a proposed rule that a previous administration used, I count these as separate rulemaking dockets. I do so because the second policy usually reverses or goes in the opposite direction as the previous administration's policy solicited comments. The same organizations often comment but with the opposition positions. Support becomes opposition and vice versa.



#### Dockets

```{r dockets}
d %>% 
  distinct(docket_id, year, docket_type) %>% 
  count(year, docket_type) %>%
  ggplot() +
  aes(x = year, y = n, fill = docket_type) +
  geom_col()

d %>% 
  distinct(docket_id, year, docket_type, agency_id) %>% 
  count(year, docket_type, agency_id) %>%
  group_by(docket_type, agency_id) %>% 
  mutate(agency_total = sum(n)) %>% 
  ungroup() %>%
  slice_max(order_by =  agency_total, n = 160) %>% 
  ggplot() +
  aes(x = year, y = n, fill = docket_type) +
  geom_col() +
  facet_wrap("agency_id", scales = "free_y")
```

#### Proposed and Final Rules

> TODO

#### Comments per rule

```{r comments-per-rule}
d %>% 
  group_by(year) %>% 
  summarise(n = sum(number_of_comments_received)) %>%
  ggplot() +
  aes(x = year, y = n) +
  geom_col()

d %>% 
  group_by(docket_type, agency_id, year) %>% 
  summarise(n = sum(number_of_comments_received, na.rm = T)) %>% 
  group_by(docket_type, agency_id) %>% 
  mutate(agency_total = sum(n, na.rm = T)) %>% 
  ungroup() %>%
  slice_max(order_by =  agency_total, n = 160) %>% 
  ggplot() +
  aes(x = year, y = n, fill = docket_type) +
  geom_col() +
  facet_wrap("agency_id", scales = "free_y") #+  scale_y_log10()
```

#### Comments

Figure \@ref(fig:comment-from) shows the sources of incoming comments

```{r, comments-from, out.width = "69%", fig.cap = "Comments on Draft Rules Posted to Regulations.gov 2006-2018"}
knitr::include_graphics(here::here("Figs", "comments-from.pdf"))
```

#### Organizations

Organizations Mobilizing the Most Public Comments 2005-2020

```{r orgs-top}
#orgs-top
load(here("data", "org_comments.Rdata"))

org_comments %<>% mutate(org_name = organization %>% 
                           str_rm_all("\\(.*| Action Fund|^The |of the United States| - .*|:.*|Mass Comment Campaign of the |/.*| USA$|\\.com") %>%
                           str_squish() %>%
                           str_to_title() %>%
                           str_replace(".*Sierra.*", "Sierra Club")%>% 
                           str_replace(".*Nrdc.*|Natural Resources Defense Council.*", "Natural Resources Defense Council")%>% 
                           str_replace(".*Center For Biological Diversity.*|Cneter For Biological Diversity", "Center For Biological Diversity")%>% 
                           str_replace(".*World Wildlife Fund.*|.WWF", "World Wildlife Fund")%>%
                           str_replace(".*Greenpeace.*", "Greenpeace")%>%
                           str_replace(".*Credo.*", "credo")%>%
                           str_replace(".*Defenders Of Wildlife.*", "Defenders Of Wildlife")%>%
                           str_replace(".*Friends Of The Earth.*", "Friends Of The Earth")%>%
                           str_replace(".*Earthjustice.*", "Earthjustice")%>%
                           str_replace(".*Defenders Of Wildlife.*", "Defenders Of Wildlife")%>%
                           str_replace(".*American Heart Association.*", "American Heart Association")%>%
                           str_replace(".*Audubon.*", "Audubon")%>%
                           str_replace(".*Wildlife Conservation Society.*", "Wildlife Conservation Society")%>%
                           str_replace(".*Oceana.*", "OCEANA")%>%
                                                      str_replace(".*Planned Parenthood.*", "Planned Parenthood")%>%

                           str_replace(".*Moveon.*|.*Move On.*", "credo")%>%
                           str_replace("Nat'l", "National")%>% 
                           str_replace(".*Ifaw.*", "INTERNATIONAL FUND FOR ANIMAL WELFARE")%>% 
                           str_replace(".*Humane Society.*|HSUS.*|.*\\bHSI\\b.*", "Humane Society")%>%
                           str_replace("Moms Rising|Momsrising|Mom's Rising|Momsrisiing", "Moms Rising")%>%
                           str_replace("Care 2|Care2", "Care2")%>%
                           str_replace("Preventobesity.*", "American Heart Association")%>%
                           str_replace("Axess.*|.*Axcess\\b.*", "AXCESS FINANCIAL")%>%
                           str_replace(".*American Petroleum Institute.*|.*\\bApi\\b.*", "American Petroleum Institute") %>%
                           str_replace(".*Consumer Energy Alliance.*", "Consumer Energy Alliance") %>%
                           str_squish() %>%
                           str_to_title(),
                         org_name = ifelse(nchar(org_name)<10, str_to_upper(org_name), org_name) )

# On non-rulemaking dockets 
#org_comments %>% filter(str_dct(organization, "Electric Cooperatives"))

save(org_comments, file =  here::here("data", "org_comments.Rdata"))


org_comments_summary <- org_comments %>% 
  group_by(org_name, docket_id) %>% 
  summarise(comments = sum(number_of_comments_received, na.rm = T) ) %>%
  ungroup() %>% 
  mutate(campaign = comments > 10) %>% 
  group_by(org_name) %>% 
  summarise(comments = sum(comments, na.rm = T),
            rules = n(),
            campaigns = sum(campaign)) %>% 
  ungroup() %>%
  mutate(percent = percent(campaigns/rules, accuracy = .1),
         average = round(comments/campaigns)) %>% 
  filter(!str_dct(org_name, "^NA$|unknown|individuals|n/a|^N$")) %>%
  arrange(-comments)  %>% 
  filter(comments > 100) 

# need to do better
nrow(org_comments_summary)
org_comments_summary$comments %>% sum()

org_comments_summary$org_name

org_comments_summary %>% 
  kablebox() 
#kable3(caption = "Organizations Mobilizing the Most Public Comments 2005-2020")

save(org_comments_summary, file =  here::here("data", "org_comments_summary.Rdata"))
```

##### The American Petroleum Institute

```{r}
org_comments %>% 
  filter(str_dct(organization, "American Petroleum Institute|\\bAPI\\b")) %>% group_by(docket_id) %>% 
  summarise(comments = sum(number_of_comments_received, na.rm = T)) %>% 
  arrange(-comments) %>% kablebox()
```


---


### Methods

#### Clustering with text reuse

My theoretical approach requires that I *attribute* form letter comments to the organizations, campaigns, and broader coalitions that mobilized them. To do so, I identify comments that share text. I find that a 10-word phrase repeated across more than a few comments is always either text copied from the proposed policy or a form letter provided by a campaign. Thus, for the text of each comment, I first remove all 10-word phrases that appear in the proposed rule (including the preamble and call for comments). Then, I identify all comments that share ten-word phrases with 99 or more other comments. Finally, I collapse these form letter comments to one representative document for hand-coding. 

For each comment on a rulemaking docket, I identify the percent of words it shares with other comments using a 10-word (or
"10-gram") moving window function, looping over each
possible pair of texts to identify matches.^[For more about n-gram window functions and comparisons with related partial matching methods such as the Smith-Waterman algorithm, see @Casas2017 and @Judge-Lord2017.]
When actors sign onto the same comment, it is clear that they are
lobbying together. However, various businesses, advocacy groups, and
citizens often comment separately, even when they are aligned. Text-reuse (using the same ten-word phrases) captures this alignment. 

Figure \@ref(fig:percent-match) shows the percent of shared text for a sample of 50 comments on the Consumer Financial Protection Bureau's 2016 Rule regulating Payday Loans. Comments are arranged by the document identifier assigned by regulations.gov on both axes. 
The black tiles on the diagonal indicates that each document has a perfect overlap with itself. Black tiles off the diagonal indicate additional pairs of identical documents. For example, 100% of the words from Comment 95976 are part of some tengram that also appears in 95977 because the exact same comment was uploaded twice. 
The cluster of grey tiles indicates a coalition of commenters using some identical text.
Comments [91130](https://www.regulations.gov/document?D=CFPB-2016-0025-91130) through [91156](https://www.regulations.gov/document?D=CFPB-2016-0025-91154) are all partial or exact matches. All are part of a mass comment campaign by Access Financial. The percent of the identical text is lower than many mass-comment campaigns because these are hand-written comments, but the n-gram method still picks up overlap in the OCRed text in the header and footer. Tengrams that appear in 100 or more comments indicate a mass comment campaign. Some agencies use similar "de-duping" software [CITE] and only provide a representative sample comment. In these cases, my linking method assumes that the example comment is representative, and I link these comments to others based on the text of the sample comment provided.

```{r percent-match, fig.show = "hold", out.width = "100%", fig.cap="Percent of Matching Text in a Sample of Public Comments"}

knitr::include_graphics(here::here("Figs", "comment_percent_match_plot-1.png")  )
```



#### Oganization types

Membership organization comments to look like this comment from the
NorthEast Hook Fisherman's Association:

> "We represent a small group of Commercial Fishermen with the Limited
> Access Handgear HA Permits, employing the use rod and reel, handlines
> or tub trawls to catch Cod, Haddock, and Pollock along with small
> quantities of other regulated and non-regulated marine fish.
> Historically and currently, our fishermen account for a small
> percentage of the groundfish landed in New England. However, the
> monetary gains obtained by the participants in this fishery are very
> important to us."
> ([NOAA-NMFS-2013-0050-0025](https://www.regulations.gov/comment/NOAA-NMFS-2013-0050-0025))

Similar groups, narrowly concerned about shrimp and halibut catch
limits, also commented on this rule on behalf of their members.

##### Membership Organizations

Membership organizations exist to serve their members interests. Unions
frequently lobbying rulemaking.

> "The American Federation of State, County and Municipal Employees
> ("AFSCME") represents 1.6 million state and local government, health
> care and child care workers and we write to express our strong support
> of the proposed rule"
> ([IRS-2016-0015-0133](%5Bhttps://www.regulations.gov/comment/IRS-2016-0015-0133))](<https://www.regulations.gov/comment/IRS-2016-0015-0133>)))

Some membership organizations join to form larger federations.

> "The Coalition on Human Needs, which represents more than 100 national
> member organizations and maintains a network of tens of thousands of
> individuals and groups nationwide, strongly supports the proposed
> rule"
> ([IRS-2016-0015-0131](%5Bhttps://www.regulations.gov/comment/IRS-2016-0015-0131))](<https://www.regulations.gov/comment/IRS-2016-0015-0131>)))

Membership organizations often claim to represent more than their
membership.

> "As a leading representative of the nation's 28 million small business
> owners, Small Business Majority is writing to comment on the U.S.
> Department of the Treasury's proposed rule on Inversions and Related
> Transactions."
> ([IRS-2016-0015-0127](%5Bhttps://www.regulations.gov/comment/IRS-2016-0015-0127))](<https://www.regulations.gov/comment/IRS-2016-0015-0127>)))

#### Classifying comments with text reuse

Figure \@ref(fig:comments-classified) shows all comments posted on
regulations.gov over time by whether they are exact or partial copies of
another comment on the same rule or not. I call comments that have
between 2 and 99 identical copies, "medium batch" because such comments
may reflect coordinated efforts among interest groups that do not
include a public pressure strategy that involves mobilizing ordinary
people. Even relatively unsuccessful public pressure campaigns yield far
more than 99 comments. "Mass comments" are comments with 100 or more
identical copies or comments that were uploaded in bulk batches of at
least 100. These were almost certainly mobilized by a public pressure
campaign. Figure \@ref(fig:comments-mass) shows that public pressure
campaigns mobilize the vast majority of comments.

```{r comments-classified, out.width = "49%", fig.cap = "Comments on Draft Rules Posted to Regulations.gov 2006-2018"}

knitr::include_graphics(here::here("Figs", "comments-mass-1.png"))
```

```{r toporgs, fig.cap = "Top mobilizers of comments posted to regulations.gov", fig.width = 7}
#FIXME Colors, replace NA with "other"
knitr::include_graphics(here::here("Figs", "toporgs.png"))
```

---

## Results

The hypotheses set out in [Chapter 2](https://judgelord.github.io/dissertation/whymail.html) are largely descriptive. 

```{hypothesis, meditated, echo = TRUE}
Most people engage in national policy processes as a result of organized public pressure campaigns.
```

> Yes, large majorities of both the hand-coded sample of comments and full dataset are form letters.

The hand-coded sample generally excludes individuals who are not clearly associated with a mass comment campaign. However, these excluded comments are a minority of the `r comments_min %>% filter(docket_id %in% comments_coded$docket_id) %>%  tally(number_of_comments_received)` comments on the hand-coded rules. Even without looking at the excluded comments (many of which may also be part of pressure campaigns), most commenters are part of organized campaigns. 

```{r}
comments_coded %>% 
  # split out mass comments submitted with org comments
  mutate(comment_type = ifelse(comment_type == "org" & comments > 99,
         "org;mass", 
         comment_type) %>% 
  str_split(";")) %>% 
  unnest(comment_type) %>% 
  mutate(comments = ifelse(comment_type == "org",
                           1, 
                           comments)) %>% 
  group_by(comment_type) %>% 
  tally(comments) %>% 
  kable3(caption = " ")
```

---

Comments that I have thus far attributed to mass comment campaigns are also a majority of the full data. In addition, many of the comments that I have yet to classify are also part of mass comment campaigns.

```{r}
# massive undercount of mass
#TODO include new, further collapsed data
comments_min %>% 
  mutate(mass = number_of_comments_received > 99) %>% 
  group_by(mass) %>% 
  tally(number_of_comments_received)%>% 
  kable3(caption = " ")
```

---


```{hypothesis, coalitions, echo = TRUE}
Public pressure campaigns are organized by *coalitions* that include groups that engage in sophisticated technical lobbying.
```

>Nearly all mass comments in the hand-coded rules were mobilized by a group that also engaged in sophisticated lobbying.

Organizations (if any) affilitated with different types of comments in the hand-coded data:

```{r}
comments_coded %>% 
  group_by(docket_id, coalition, coalition_comments, coalition_type) %>% 
  mutate(comment_type = comment_type %>% as.factor()) %>%
  count(comment_type) %>%
  ungroup() %>% 
  drop_na(comment_type) %>% 
  filter(!comment_type %in% c("NA", "coalition", "mass")) %>% 
  pivot_wider(names_from =  comment_type, values_from = n) %>%
  arrange(-coalition_comments) %>% 
  kable3(caption = " ")
```

---


```{hypothesis, public, echo = TRUE}
Public interest group coalitions mobilize *more often* than private interest group (e.g., business-led) coalitions.
```

> Yes, public interest coalitions use public pressure campaigns more often, both in the absolute number of campaigns and the share of lobbying efforts that involve a pressure campaign.

```{r}
coalitions_coded %>%
  mutate(mass_comment_campaign = coalition_comments > 99) %>% 
  count(coalition_type, mass_comment_campaign) %>% 
  drop_na(coalition_type) %>%
  kable3(caption = " ")
```

---


```{hypothesis, public-success, echo = TRUE}
Public interest group coalitions mobilize *more successfully* than private interest group (e.g., business-led) coalitions. 
```

> Yes, public interest coalitions mobilize far more comments and far more comments on average.

```{r}
coalitions_coded %>% group_by(coalition_type) %>% 
  summarise(total_comments = sum(coalition_comments),
            average_comments = mean(comments)) %>% drop_na(coalition_type) %>% kable3(caption = " ")
```

---


```{hypothesis, resources, echo = TRUE}
Public pressure campaigns targeting national policy are most often run by large national policy advocacy organizations.
```

> Yes.

```{hypothesis, disrupt, echo = TRUE}
If narrow private interest groups (e.g., businesses) launch public pressure campaigns, it is a response to an opposing campaign. 
```

> TBD: In these data (high salience rules), almost all coalitions are opposed. 

```{r}
coalitions_coded %>% 
  count(coalition_type, coalition_unopposed) %>% drop_na(coalition_type) %>% 
  kable3(caption = " ")
```


